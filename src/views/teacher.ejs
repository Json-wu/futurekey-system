<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher management system</title>
    <!-- 引入 Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
    <!-- 遮罩层 -->
    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="global-message" id="globalMessage"></div>
    <div class="custom-confirm" id="customConfirm">
        <div class="message" id="confirmMessage"></div>
        <div class="buttons">
            <button class="confirm" id="confirmYes">Yes</button>
            <button class="cancel" id="confirmNo">No</button>
        </div>
    </div>
    <div class="container">
        <input type="hidden" id="teacherId" value="<%=teacher_id %>">
        <input type="hidden" id="teacherName" value="<%=teacher_name %>">
        <!-- Top Area -->
        <div class="header">
            <div class="welcome-message">Welcome, Teacher <%=teacher_name %>！</div>
            <div class="notification-icon" onclick="toggleNotificationPopup()">
                <i class="fas fa-bell"></i>
                <span class="badge" id="notification-count" style="display: none;"></span>
            </div>
            <div class="notification-popup" id="notification-popup">
                <ul id="notification-list"></ul>
            </div>
        </div>
        <!-- 日期选择和统计按钮 -->
        <div class="date-buttons" id="static_date" style="display: none;">
            <input type="date" id="startDate" class="date-input">~
            <input style="margin-left: 10px;" type="date" id="endDate" class="date-input">
            <button onclick="calculateStatistics()">Statistics</button>
        </div>
        <!-- 日期选择和前一天、后一天按钮 -->
        <div class="date-buttons" id="course_date">
            <button onclick="changeDate(-1)"><i class="fas fa-chevron-left"></i></button>
            <input style="margin-left: 10px;" type="date" id="selectedDate" value="2024-12-02" onchange="fetchData()">
            <button onclick="changeDate(1)"><i class="fas fa-chevron-right"></i></button>
        </div>

       
        <!-- Course Management -->
        <div id="courseDiv" class="courseDiv" style="display: block;">
             <!-- 当前时区显示 -->
            <div class="timezone-container">
                <label for="timezoneSelect">timezone：</label>
                <select id="timezoneSelect" onchange="updateTimezone()">
                    <option value="America/Los_Angeles">Pacific Time</option>
                    <option value="America/Denver">Mountain Time</option>
                    <option value="America/Chicago">Central Time</option>
                    <option value="America/New_York">Eastern Time</option>
                    <option value="Asia/Shanghai">Shanghai Time</option>
                    <!-- 其他时区选项 -->
                </select>
            </div>
            <div style="display: flex; align-items: center; margin: 20px 0;">
                <hr style="flex-grow: 1; border: none; border-top: 1px solid #f7f9fc;">
                <span style="padding: 0 10px; color: #FFFFFF;" id="courseTitle">My courses</span>
                <hr style="flex-grow: 1; border: none; border-top: 1px solid #f7f9fc;">
            </div>
            <!-- 课程列表 -->
            <div class="course-list" id="courseList">
            </div>
            <!-- 全选按钮栏-->
            <div class="selectAll2" id ="ss">
                <label><input type="checkbox" class="courseCheckBox2" id="selectAll" onclick="selectAll()">Select All</label>
            </div>

            <div class="button-group" id="course_Leave" style="display: none;">
                <button class="cancle-button" onclick="hideLeaveCheck()">Cancel</button>
                <button class="leave-button" onclick="openLeaveModal()">Next</button>
            </div>

            <!-- 底部按钮 -->
            <div class="button-group" id="course_bottom">
                <button class="stats-button" onclick="showStatistics()">Class Statistics</button>
                <button class="leave-button" onclick="showLeaveCheck()">Leave Request</button>
            </div>
        </div>
        <!-- Course Consumption Statistics -->
        <div id="Statistics" style="display: none;" class="courseDiv">
            <div style="display: flex; align-items: center; margin: 20px 0;">
                <hr style="flex-grow: 1; border: none; border-top: 1px solid #f7f9fc;">
                <span style="padding: 0 10px; color: #FFFFFF;">My Class Statistics</span>
                <hr style="flex-grow: 1; border: none; border-top: 1px solid #f7f9fc;">
            </div>
            <!-- 课消统计 -->
            <div id="total" class="course-list">
                <p id="totalDuration">Total Duration: 0.00 hours</p>
                <div class="table-container">
                    <table border="1">
                        <thead>
                            <tr>
                                <th class="head-th">Course Name</th>
                                <th class="head-th">Start Time</th>
                                <th class="head-th">End Time</th>
                                <th class="head-th">Duration (hours)</th>
                            </tr>
                        </thead>
                        <tbody id="TotalList">
                            <!-- 课程明细将动态插入到这里 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 底部按钮 -->
            <div class="button-group">
                <button class="cancle-button" onclick="hideStatistics()">Cancel</button>
                <button class="leave-button" onclick="printDiv('total')">Print</button>
            </div>
        </div>
        <!-- Course Details -->
        <div id="courseDetails" style="display: none;">
            <div style="display: flex; align-items: center; ">
                <hr style="flex-grow: 1; border: none; border-top: 1px solid #f7f9fc;">
                <span style="padding: 0 10px; color: #FFFFFF;">Course Details</span>
                <hr style="flex-grow: 1; border: none; border-top: 1px solid #f7f9fc;">
            </div>
            <div class="table-container2" id="detailDiv">
                <div class="input-group_detail">
                    <label>Course Name:</label>
                    <span id="courseName"></span>
                </div>
                <div class="input-group_detail">
                    <label>Class Time:</label>
                    <span id="courseTime"></span>
                </div>
                <div class="input-group_detail" style="display: none;">
                    <label>English Level:</label>
                    <span id="courseLevel"></span>
                </div>
                <div class="input-group_detail">
                    <label>Class Category:</label>
                    <span id="courseType"></span>
                </div>
                <div class="input-group_detail" id = "div_pro" style="display: none;">
                    <label>Class Progress:</label>
                    <span>Unit_</span>
                    <select id="unit">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                    </select>
                    <span>Week_</span>
                    <select id="week">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                    </select>
                    <span>Day_</span>
                    <select id="day">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
                <div class="input-group_detail">
                    <label>Regular Students:</label>
                    <span id="who"></span>
                </div>
                <div class="input-group_detail">
                    <label>Signed Up:</label>
                    <span id="signedup"></span>
                </div>

                <div id="studentAttendance" class="studentList">
                    <!-- 学生考勤将动态插入到这里 -->
                </div>
                <div id="studentList" class="studentList">
                    <!-- 学生评价将动态插入到这里 -->
                </div>

                <div class="div_container">
                    <!-- Tabs -->
                    <div class="tabs">
                        <div class="tab active" id="preClassTab">Lesson Planning</div>
                        <div class="tab" id="afterClassTab">Class Report & Homework</div>
                    </div>

                    <!-- Tab content -->
                    <div class="tab-content">
                        <textarea placeholder="Please add class progress information, syllabus, or preview material." id="coursetext_preview"
                            style="display: none;"></textarea>
                        <textarea placeholder="Please leave comments on this session, and/or leave homework." id="coursetext_homework"
                            style="display: none;"></textarea>
                    </div>

                    <!-- Upload section -->
                    <div class="upload-section">
                        <img src="data:image/png;base64,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" alt="upload icon" onclick="checkfile()">
                        <div class="text">Click Upload file</div>
                        <div class="description">A maximum of 5 attachments can be uploaded, and the size of each
                            attachment cannot exceed 10M
                        </div>
                        <input hidden type="file" id="fileUpload" onchange="uploadFile()" multiple>
                        <div class="uploaded-files" id="uploadedFiles_preview" style="display: none;"></div>
                        <div class="uploaded-files" id="uploadedFiles_homework" style="display: none;"></div>
                    </div>
                </div>
              
            </div>
            <!-- 底部按钮 -->
            <div class="button-group">
                <button class="cancle-button" onclick="hideDetail()">Cancel</button>
                <button class="leave-button" onclick="Save()">Save</button>
            </div>
        </div>
    </div>
    <!-- Full-day Leave Modal -->
    <div id="leaveModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-btn" onclick="closeLeaveModal()">&times;</span>
            <h2>Leave Info</h2>
            <p>You are applying for leave, please confirm your leave time and reason.</p>
            <div class="row-group">
                <label>Leave Time：</label>
                <span id="leave_time"></span>
            </div>
            <div class="row-group">
                <label>Leave Reason：</label>
                <select id="leaveReason">
                    <option value="personal">Personal Leave</option>
                    <option value="sick">Sick Leave</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="row-group" style="height:50px;">
                <label>Leave Comment：</label>
                <textarea id="leaveComment" rows="3" placeholder="Enter your comment here..."></textarea>
            </div>
            <input type="hidden" id="leaveCourse" value="">
          
            <div class="modal-footer">
                <button class="cancle-button1" onclick="closeLeaveModal()">Cancel</button>
                <button class="leave-button1" onclick="submitLeaveRequest()">Submit</button>
            </div>
        </div>
    </div>
</body>

</html>
<style>
     .global-message {
        position: fixed;
        top: 3%;
        left: 50%;
        transform: translateX(-50%);
        padding: 15px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        display: none; /* 默认隐藏 */
    }
    .global-message.success {
        background-color: #4CAF50; /* 绿色背景 */
        color: white;
    }
    .global-message.error {
        background-color: #f44336; /* 红色背景 */
        color: white;
    }
    .global-message.info {
        background-color: #2196F3; /* 蓝色背景 */
        color: white;
    }
    .global-message.warning {
        background-color: #ff9800; /* 橙色背景 */
        color: white;
    }
    body {
        margin: 0;
        font-family: 'Arial', sans-serif;
        background: #FFFFFF;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        overflow-y: hidden;
        min-width: 380px;
    }

    .icon {
        width: 40px;
        height: 40px;
    }

    .text_dcro {
        text-decoration: line-through;
    }

    .div_container {
        width: 98%;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        margin-top: 10px;
        padding-bottom: 10px;
    }

    .selectAll {
        margin-bottom: 10px;
        height: 40px;
        background-color: #bac3f6;
        padding: 10px;
        position: fixed;
        bottom: 96px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        border-top: 1px solid #ddd;
        justify-content: space-between;
        padding-bottom: 20px;
        border-radius: 8px;
    }

    .selectAll2 {
        display: none;
        /* width: 100%;
        margin-bottom: 10px;
        height: 40px;
        background-color: #f2f9f8;
        padding: 10px;
        justify-content: center; */
    }
    .selectAll label {
        justify-content: center;
    }

    .leaveShow {
        display: block;
    }

    .leaveHide {
        display: none;
    }

    .accept {
        background-color: #E0F3FF;
        color:#647BF3;
        border-radius: 5px;
    }

    .refuse {
        background-color: #FFEEE0;
        color:#FCBEA4;
        border-radius: 5px;
    }

    .courseCheckBox,
    .courseCheckBox2 {
        height: 15px;
        width: 15px;
    }

    .tabs {
        display: flex;
        border-bottom: 2px solid #e0e0e0;
    }

    .tab {
        flex: 1;
        text-align: center;
        padding: 10px;
        cursor: pointer;
        font-weight: bold;
        color: #666;
        transition: background-color 0.3s, color 0.3s;
    }

    .tab.active {
        background-color: #4a90e2;
        color: white;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
    }

    .tab-content {
        margin-top: 10px;
        padding: 10px;
    }

    .tab-content textarea {
        width: 96%;
        height: 90px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 12px;
        resize: none;
    }

    .upload-section {
        margin: 10px;
        padding: 10px;
        border: 2px dashed #4a90e2;
        border-radius: 8px;
        text-align: center;
        background-color: #f0f7ff;
        color: #4a90e2;
    }

    .upload-section img {
        width: 50px;
        height: 50px;
    }

    .upload-section .text {
        font-size: 16px;
        font-weight: bold;
        margin: 10px 0;
    }

    .upload-section .description {
        font-size: 12px;
        color: #777;
    }

    .courseDiv {
        height: 100vh;
        /* 可选：添加内边距 */
        box-sizing: border-box;
        /* 确保内边距和边框包含在元素的总宽度和高度内 */
        display: flex;
        flex-direction: column;
    }

    /* 自适应内部元素 */
    .courseDiv>* {
        width: 100%;
        /* 让内部元素宽度自适应父容器 */
        box-sizing: border-box;
        /* 确保内边距和边框包含在元素的总宽度和高度内 */
    }

    /* 可选：美化滚动条 */
    #courseDiv::-webkit-scrollbar {
        width: 12px;
    }

    #courseDiv::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    #courseDiv::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 6px;
    }

    #courseDiv::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    .container {
        background: linear-gradient(to bottom, #2F51FF, #F7F9FC);
        width: 360px;
        padding: 20px;
        border-radius: 20px;
        box-shadow: 0px 4px 20px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        height: 90vh;
        overflow-y: auto;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .welcome-message {
        font-size: 16px;
        color: #ffffff;
    }

    .notification-icon {
        font-size: 24px;
        color: #e8ecf1;
        cursor: pointer;
        position: relative;
        display: inline-block;
    }

    .notification-icon .badge {
        position: absolute;
        right: -8px;
        background-color: red;
        color: white;
        border-radius: 50%;
        padding: 6px 9px 6px 4px;
        font-size: 5px;
        width: 5px;
    }

    .notification-popup {
        display: none;
        position: absolute;
        top: 50px;
        right: 0;
        width: 200px;
        max-height: 400px;
        overflow-y: auto;
        background-color: white;
        border: 1px solid #ccc;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
    }

    .notification-popup ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .notification-popup li {
        padding: 10px;
        border-bottom: 1px solid #eee;
        font-size: 10px;
    }

    .notification-popup li:last-child {
        border-bottom: none;
    }

    .notification-popup li a {
        color: #333;
        text-decoration: none;
    }

    .input-group {
        margin-bottom: 20px;
    }

    .input-group label {
        display: block;
        font-size: 14px;
        margin-bottom: 8px;
        color: #ffffff;
    }

    .input-group input {
        width: 94%;
        padding: 10px;
        font-size: 16px;
        border-radius: 8px;
        border: 1px solid #ddd;
    }

    .input-group select {
        width: 94%;
        padding: 10px;
        font-size: 16px;
        border-radius: 8px;
        border: 1px solid #ddd;
    }

    .row-group {
        width: 90%;
        height: 20px;
        margin-top: 10px;
        margin-left: auto;
        margin-right: auto;
        margin-bottom: 20px;
        background-color: #ffffff;
        display: flex;
        align-items: center;
        padding: 10px;
        border-radius: 10px;
    }

    .row-group label {
        width: 200px;
        display: block;
        font-size: 14px;
        color: #0c0c0c;
        margin-bottom: 8px;
        margin-right: 10px;
        text-align: right;
    }

    .row-group span {
        width: 100%;
        font-size: 14px;
    }

    .input-group_detail {
        width: 98%;
        height: auto;
        margin-top: 10px;
        margin-left: auto;
        margin-right: auto;
        background-color: #ffffff;
        display: flex;
        align-items: center;
        padding: 10px 0 10px 10px;
        border-radius: 8px;
    }

    .input-group_detail label {
        display: block;
        font-size: 12px;
        color: #6b6969;
        margin-right: 10px;
    }

    .input-group_detail span {
        display: block;
        font-size: 12px;
        color: #2D2D2D;
        margin-right: 10px;
        font-weight: bold;
    }

    #div_pro span {
        margin-left: 3px;
        display: inline;
        font-size: 12px;
        color: #2D2D2D;
        margin-right: 0px !important;
    }
    #div_pro select {
        width: 20%;
        padding: 5px;
        margin-top: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    #div_pro label {
        display: inline;
        font-size: 12px;
        color: #6b6969;
        margin-right: 10px;
    }

    .input-group_detail2 {
        width: 90%;
        height: 80px;
        margin-top: 10px;
        margin-left: auto;
        margin-right: auto;
        background-color: #ffffff;
        display: flex;
        align-items: center;
        padding: 10px;
        border-radius: 10px;
    }

    .input-group_detail2 textarea {
        width: 70%;
        height: 80px;
        display: block;
        font-size: 12px;
        color: #080808;
        margin-right: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        resize: none;
    }

    .date-buttons {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .date-buttons button {
        background-color: #2e4deb;
        color: white;
        border: none;
        padding: 10px;
        font-size: 16px;
        border-radius: 8px;
        cursor: pointer;
        width: 30%;
        /* 调整按钮宽度 */
        height: 50px;
        /* 调整按钮高度 */
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .date-buttons3 button {
        background-color: #007bff;
        color: white;
        text-align: center;
        padding: 12px;
        font-size: 16px;
        font-weight: bold;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        width: 30%;
        /* 确保两个按钮在一行内 */
    }

    .date-buttons input[type="date"] {
        flex-grow: 1;
        margin: 0 10px 0 0;
        padding: 10px;
        font-size: 16px;
        border-radius: 8px;
        border: 1px solid #ddd;
    }

    .course-list {
        flex: 1;
        padding-bottom: 85px;
    }

    .course-item {
        background-color: #f3f6ff;
        border-radius: 10px;
        padding: 15px;
        margin: 0 0 15px auto;
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        cursor: pointer;
        position: relative;
        /* 添加鼠标指针样式 */
    }

    .course-item-absent {
        background-color: #edb781;
    }

    .course-icon {
        width: 40px;
        height: 40px;
        /* background-color: #ffcc99; */
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-right: 10px;
        font-size: 18px;
    }

    .add-course {
        cursor: pointer;
        font-size: 14px;
        color: #999;
    }

    .course-info {
        flex: 1;
    }

    .course-info h4 {
        margin: 0;
        font-size: 16px;
        color: #333;
    }

    .course-info p {
        margin: 5px 0;
        font-size: 14px;
        color: #999;
    }

    .courseinfo-ico {
        background-color: #ffcc99;
    }

    .course-arrow {
        font-size: 18px;
        color: #007bff;
    }

    .button-group {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        justify-content: space-between;
        padding-bottom: 20px;
        width: 70%; /* 设置宽度为100% */
        max-width: 800px; /* 设置最大宽度与container一致 */
    }

    .cancle-button {
        color: #2F51FF;
        background-color: #f2efef;
        text-align: center;
        padding: 12px;
        font-size: 16px;
        font-weight: bold;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        width: 48%;
        height: 55px;
    }
    .cancle-button:hover,
    .cancle-button1:hover {
        background-color: #949191;
    }

    .cancle-button1 {
        color: #2F51FF;
        background-color: #f2efef;
        text-align: center;
        padding: 12px;
        font-size: 14px;
        font-weight: bold;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        width: 48%;
        height: 55px;
    }

    .stats-button,
    .leave-button {
        background-color: #2F51FF;
        color: white;
        text-align: center;
        padding: 12px;
        font-size: 16px;
        font-weight: bold;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        width: 48%;
        height: 55px;
        /* 确保两个按钮在一行内 */
    }

    .date-buttons button:hover,
    .stats-button:hover,
    .leave-button1:hover,
    .leave-button:hover {
        background-color: #0056b3;
    }

    .leave-button1 {
        background-color: #2F51FF;
        color: white;
        text-align: center;
        padding: 12px;
        font-size: 14px;
        font-weight: bold;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        width: 48%;
        height: 55px;
        /* 确保两个按钮在一行内 */
    }

    /* Modal Background */
    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.4);
    }

    /* Modal Content */
    .modal-content {
        background-color: #dae1eb;
        margin: 15% auto;
        padding: 20px;
        border-radius: 5px;
        width: 400px;
        height: 350px;
        position: relative;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .modal-content textarea {
        margin-top: 5px;
        width: 99%;
    }

    /* Close Button */
    .close-btn {
        color: #aaa;
        position: absolute;
        right: 10px;
        top: 10px;
        font-size: 18px;
        cursor: pointer;
    }

    .close-btn:hover {
        color: #000;
    }

    /* Modal Title */
    h2 {
        font-size: 18px;
        margin: 0 0 10px 0;
    }

    /* Select Dropdown */
    select {
        width: 100%;
        padding: 5px;
        margin-top: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    /* Modal Footer */
    .modal-footer {
        flex: 1;
        border-top: 1px solid #ddd;
        display: flex;
        justify-content: space-between;
    }

    #cancelBtn {
        background-color: #f0f0f0;
        color: #333;
    }

    #submitBtn {
        background-color: #007bff;
        color: white;
    }

    #submitBtn:hover {
        background-color: #0056b3;
    }

    .upload-container {
        text-align: left;
        background-color: #ffffff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0px 4px 20px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 15px;
        width: 100%;
        max-width: 600px;
    }

    .upload-icon {
        font-size: 36px;
        color: #007bff;
        text-align: left;
    }

    .upload-btn-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
    }

    .btn {
        border: 2px solid #007bff;
        color: #007bff;
        background-color: #ffffff;
        padding: 10px 20px;
        font-size: 12px;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn:hover {
        background-color: #007bff;
        color: #ffffff;
    }

    .upload-btn-wrapper input[type="file"] {
        font-size: 100px;
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        cursor: pointer;
    }

    .file-name {
        font-size: 14px;
        color: #666;
        flex: 1;
        /* 文件名部分填满剩余空间 */
        white-space: nowrap;
        /* 防止文件名换行 */
        overflow: hidden;
        text-overflow: ellipsis;
        /* 超长文件名显示省略号 */
    }

    .status {
        font-size: 14px;
        color: #28a745;
        margin-top: 10px;
    }


    .table-container {
        margin-bottom: 20px;
        min-height: 300px;
        overflow-x: hidden;
        border: 1px solid #ddd;
    }

    .table-container2 {
        margin-bottom: 85px;
        min-height: 200px;
        overflow-x: hidden;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    table,
    th,
    td {
        border: 1px solid #ddd;
    }

    th,
    td {
        padding: 10px;
        text-align: left;
    }

    th {
        background-color: #f2f2f2;
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .head-th {
        background-color: #97a3df;
    }

    tbody tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    /* Custom scrollbar styles */
    .table-container::-webkit-scrollbar {
        width: 12px;
    }

    .table-container::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .table-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 6px;
    }

    .table-container::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    /* Date input styles */
    .date-input {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 16px;
        margin-right: 10px;
    }

    .rating-container {
        width: 98%;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 0px;
        margin: 8px 8px 0 5px;
    }

    .dropdown {
        background: #2F51FF0F;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        cursor: pointer;
        border-radius: 4px;
        padding: 0 10px 0 20px;
        height: 35px;
        position: relative;
    }

    .dropdown span {
        color: #070707;
        font-size: 14px;
        font-weight: bold;
    }

    .dropdown i {
        color: #31373D;
    }

    .arrow {
        transition: transform 0.5s;
    }

    .rotated {
        transform: rotate(90deg);
    }

    .hidden {
        display: none;
    }

    .rating-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 10px 0 0 10px;
    }

    .rating-item span,
    .comment-box label {
        color: #00000073;
        font-size: 12px;
        font-weight: bold;
    }

    .stars {
        display: flex;
        cursor: pointer;
    }

    .star {
        font-size: 20px !important;
        color: lightgray;
        margin-left: auto;
        border-radius: 1px;
    }

    .star.selected {
        color: gold;
    }

    .score {
        width: 35px;
    }

    .comment-box {
        font-size: 12px;
        margin-left: 10px;
        margin-top: 10px;
    }

    .comment-box textarea {
        width: 94%;
        height: 40px;
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 10px;
        font-size: 12px;
        resize: none;
        margin-top: 10px;
    }

    .char-counter {
        text-align: right;
        font-size: 12px;
        margin-right: 10px;
        color: gray;
    }

    .details {
        margin: 10px;
    }

    .upload-icon {
        cursor: pointer;
        font-size: 20px;
        color: #080808;
    }

    .upload-icon input[type="file"] {
        display: none;
    }

    .uploaded-files {
        margin-top: 10px;
        /* height: 100%;
overflow-y: auto; */
    }

    .uploaded-file {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }

    .uploaded-file span {
        margin-right: 10px;
    }

    .uploaded-file i {
        font-size: 10px;
    }

    .delete-icon {
        cursor: pointer;
        color: red;
    }

    .radio-group {
        display: inline-block;
    }

    .radio-group label {
        display: inline-block;
        margin-right: 10px;
        margin-top: 0px !important;
        color: #31373D;
    }

    .attendance-group {
        display: inline-block;
        display: flex;
        margin: -10px 10px 0 -5px
    }

    .attendance-group label {
        display: inline-block;
        font-size: 12px;
    }

    .leave-icon {
        color: red;
        font-size: 14px;
        display: none;
        /* 默认隐藏 */
    }

    .leave-icon.show {
        display: inline-block;
        /* 显示图标 */
    }

    .leave-icon.hide {
        display: none;
        /* 显示图标 */
    }

    .timezone-container {
        display: flex;
        align-items: center;
    }

    .timezone-container label {
        color: #FFFFFF;
        margin-right: 10px;
        margin-top: 0 !important;
    }

    .timezone-container select {
        width: 150px;
    }

    .new-badge {
        background: linear-gradient(to bottom, #FF6161, #FFc197);
        color: white;
        padding: 5px 10px;
        font-size: 12px;
        border-radius: 20px;
        position: absolute;
        top: -10px;
        right: 0px;
    }

    .new-badge-stu {
        background: linear-gradient(to bottom, #FF6161, #FFc197);
        color: white;
        padding: 5px;
        font-size: 8px;
        border-radius: 50%;
        position: absolute;
        top: -12px;
        left: -2px;
        width: 17px;
        height: 17px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .rlable label {
        border-radius: 3px;
        float: right;
        margin-right: 10px;
        padding: 1px 2px 1px 2px;
    }

    .studentList {
        background-color: #FFFFFF;
        border-radius: 8px;
        margin-top: 10px;
        padding: 10px;
    }



    .student {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #ccc;
    }

    .student:last-child {
        border-bottom: none;
    }

    .student-info {
        display: flex;
        align-items: center;
    }

    .student-name {
        margin-left: 10px;
    }

    .student_att {
        background: #2F51FF0F;
        padding: 10px;
        border-radius: 8px;
        margin-top: 10px;
    }

    .status {
        font-size: 14px;
        color: #777;
    }

    .taster {
        background-color: #4a90e2;
        color: #fff;
        padding: 2px 5px;
        font-size: 12px;
        border-radius: 4px;
        margin-left: 5px;
    }

    .attendance-status {
        display: flex;
        align-items: center;
    }

    .attendance-status select {
        padding: 5px;
        border: 1px solid #7AA7FE;
        border-radius: 4px;
        color: #484545;
    }

    .attendance-status .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 5px;
    }

    .blue {
        background-color: #4a90e2;
    }

    .green {
        background-color: #7ed321;
    }

    .red {
        background-color: #d0021b;
    }

    .orange {
        background-color: #f5a623;
    }


    /* 媒体查询，用于调整PC端显示样式 */
    @media (min-width: 768px) {
        .container,
        .selectAll,
        .button-group {
            width: 600px;
        }

        .input-group input,
        .input-group select {
            width: 100%;
        }

        .notification-popup {
            top: 90px;
        }
    }

    /* 媒体查询，用于调整移动端显示样式 */
    @media (max-width: 767px) {
        .container {
            height: 90vh;
            /* 调整高度以尽量铺满屏幕 */
        }

        .course-list {
            /* max-height: 360px; */
            /* 移除最大高度限制 */
            flex-grow: 1;
            /* 使课程列表区域拉伸 */
        }

        .notification-popup {
            top: 75px;
        }

        .date-buttons input[type="date"] {
            font-size: 12px;
        }

        .date-buttons button {
            height: 40px;
        }
        .button-group {
            width: 85%;
        }

        .selectAll {
            width: 84% !important;
            left:50%;
        }

        .custom-confirm {
            width: 75% !important;
        }
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: none; /* 默认隐藏 */
    }
    
    .custom-confirm {
        line-height: 1.6;
        position: fixed;
        width: 55%;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #dae1eb;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        z-index: 1001;
        display: none; /* 默认隐藏 */
    }
    .custom-confirm .message {
        margin-bottom: 20px;
    }
    .custom-confirm .buttons {
        text-align: right;
    }
    .custom-confirm .buttons button {
        margin-left: 10px;
        padding: 5px 10px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
    }
    .custom-confirm .buttons .confirm {
        background-color: #4CAF50; /* 绿色背景 */
        color: white;
    }
    .custom-confirm .buttons .cancel {
        background-color: #f44336; /* 红色背景 */
        color: white;
    }

    .clist {
        padding-bottom: 145px;
    }
</style>
<script>
    const url = "/classroom";
    let nowpage = "course";
    let filetype_check = "preview";
    let isLeaveCheck = false;
    let courseChecks =[];
    document.getElementById('uploadedFiles_preview').style.display = 'block';
    document.getElementById('coursetext_preview').style.display = 'block';
    const subid = document.getElementById('teacherId').value;
    const teacher_name = document.getElementById('teacherName').value;
    let current_eventId = "";
    let today_course = [];
    let current_course = null;
    let timezoneSet = 'America/New_York';
    let current_date;
    const tzSet = {
        "GMT-1": "Atlantic/Azores",
        "GMT-2": "America/Noronha",
        "GMT-3": "America/Sao_Paulo",
        "GMT-4": "America/New_York",
        "GMT-5": "America/Chicago",
        "GMT-6": "America/Denver",
        "GMT-7": "America/Los_Angeles",
        "GMT-8": "America/Anchorage",
        "GMT-9": "Pacific/Honolulu",
        "GMT+0": "UTC",
        "GMT+1": "Europe/London",
        "GMT+2": "Europe/Paris",
        "GMT+3": "Europe/Moscow",
        "GMT+4": "Asia/Dubai",
        "GMT+5": "Asia/Karachi",
        "GMT+6": "Asia/Dhaka",
        "GMT+7": "Asia/Bangkok",
        "GMT+8": "Asia/Shanghai",
        "GMT+9": "Asia/Tokyo",
        "GMT+10": "Australia/Sydney",
        "GMT+11": "Pacific/Noumea",
        "GMT+12": "Pacific/Auckland"
    };

    document.addEventListener('DOMContentLoaded', () => {
        // const timeZone = new Date().toLocaleTimeString('en-us', { timeZoneName: 'short' }).split(' ')[2];
        //timezoneSet = tzSet[timeZone];
        if(window.localStorage.getItem('timezone')){
            timezoneSet = window.localStorage.getItem('timezone');
        }else{
            timezoneSet = 'America/New_York';
            window.localStorage.setItem('timezone', timezoneSet);
        }
        
        document.getElementById('timezoneSelect').value = timezoneSet;
        // document.getElementById('timezone').innerText = 'timezone： ' + timeZone;

        current_date = formatDate();

        const selectedDate = document.getElementById('selectedDate');
        selectedDate.value = current_date;
        fetchData();
        fetchNewMessages();

        // Poll for new messages every 30 seconds
        setInterval(fetchNewMessages, 30000);
    });

    function showMessage(message, type = 'info') {
        const messageElement = document.getElementById('globalMessage');
        messageElement.textContent = message;

        // 移除所有类型的类
        messageElement.classList.remove('success', 'error', 'info', 'warning');

        // 根据类型添加相应的类
        messageElement.classList.add(type);

        messageElement.style.display = 'block';

         // 添加点击事件监听器，点击时隐藏消息
        messageElement.onclick = () => {
            messageElement.style.display = 'none';
        };

        setTimeout(() => {
            messageElement.style.display = 'none';
        }, 5000); // 5秒后自动消失
    }

    function showConfirm(message, callback) {
        const confirmElement = document.getElementById('customConfirm');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmYes = document.getElementById('confirmYes');
        const confirmNo = document.getElementById('confirmNo');
        const overlay = document.getElementById('modalOverlay');

        confirmMessage.textContent = message;
        confirmElement.style.display = 'block';
        overlay.style.display = 'block';

        confirmYes.onclick = () => {
            confirmElement.style.display = 'none';
            overlay.style.display = 'none';
            callback(true);
        };

        confirmNo.onclick = () => {
            confirmElement.style.display = 'none';
            overlay.style.display = 'none';
            callback(false);
        };
    }
    // Tab switching logic
    const preClassTab = document.getElementById("preClassTab");
    const afterClassTab = document.getElementById("afterClassTab");
    const coursetext_preview = document.getElementById("coursetext_preview");
    const coursetext_homework = document.getElementById("coursetext_homework");
    const fileUpload_preview = document.getElementById("uploadedFiles_preview");
    const fileUpload_homework = document.getElementById("uploadedFiles_homework");

    preClassTab.addEventListener("click", () => {
        filetype_check = "preview";
        preClassTab.classList.add("active");
        afterClassTab.classList.remove("active");

        coursetext_preview.style.display = 'block';
        fileUpload_preview.style.display = 'block';
        coursetext_homework.style.display = 'none';
        fileUpload_homework.style.display = 'none';
    });

    afterClassTab.addEventListener("click", () => {
        filetype_check = "homework";
        afterClassTab.classList.add("active");
        preClassTab.classList.remove("active");

        coursetext_preview.style.display = 'none';
        fileUpload_preview.style.display = 'none';
        coursetext_homework.style.display = 'block';
        fileUpload_homework.style.display = 'block';
    });

    function showLeaveCheck() {
        isLeaveCheck = true;
        
        // document.querySelector('.selectAll').style.display = 'block';
        document.getElementById('ss').classList.remove('selectAll2');
        document.getElementById('ss').classList.add('selectAll');
        document.getElementById('course_bottom').style.display = 'none';
        document.getElementById('courseTitle').innerText = 'Course Selection';
        document.getElementById('course_Leave').style.removeProperty('display');
        document.getElementById('courseList').classList.add('clist');

        fetchData();
    }

    function hideLeaveCheck() {
        courseChecks = [];
        isLeaveCheck = false;
        document.getElementById('ss').classList.add('selectAll2');
        document.getElementById('ss').classList.remove('selectAll');
        document.getElementById('courseList').classList.remove('clist');
        document.getElementById('course_bottom').style.removeProperty('display');
        document.getElementById('courseTitle').innerText = 'My Course';
        document.getElementById('course_Leave').style.display = 'none';

        const checkboxes1 = document.querySelectorAll('.course-arrow');
        checkboxes1.forEach(checkbox => {
            checkbox.classList.remove('leaveHide');
        });

        const checkboxes2 = document.querySelectorAll('.rlable');
        checkboxes2.forEach(checkbox => {
            checkbox.classList.remove('leaveHide');
        });

        const checkboxes = document.querySelectorAll('.courseCheckBox');
        checkboxes.forEach(checkbox => {
            checkbox.classList.add('leaveHide');
        });
    }

    function selectAll() {
        const selectAllVal = document.getElementById('selectAll').checked;
        const checkboxes = document.querySelectorAll('.courseCheckBox');
        checkboxes.forEach(checkbox => {
            if(checkbox.disabled){
                return;
            }
            checkbox.checked = selectAllVal;
        });
    }

    function updateTimezone() {
        timezoneSet = document.getElementById('timezoneSelect').value;
        window.localStorage.setItem('timezone', timezoneSet);
        fetchData();
    }
    // Function to open the leave modal
    function openLeaveModal() {
        courseChecks=[];
        // 获取所有勾选的课程
        const checkboxes = document.querySelectorAll('.courseCheckBox');
        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                courseChecks.push(checkbox.value);
            }
        });
        if(courseChecks.length == 0){
            showMessage('Please select at least one course', 'warning');
            return;
        }

        document.getElementById('leave_time').innerText = current_date
        document.getElementById('leaveModal').style.display = 'flex';
    }

    // Function to close the leave modal
    function closeLeaveModal() {
        document.getElementById('leaveCourse').value = '';
        document.getElementById('leaveModal').style.display = 'none';
    }

    // Function to submit the leave request
    function submitLeaveRequest() {
        const reason = document.getElementById('leaveReason').value;
        const comment = document.getElementById('leaveComment').value;
        if(reason=='other' && comment==''){
            showMessage('Please enter the reason for leave', 'warning');
            return;
        }
        try {
            let body = {
                code: subid,
                name: teacher_name,
                reason,
                comment,
                date: current_date,
                courseChecks
            };
            
            fetch(url + '/leave/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            }).then(response => response.json())
                .then(data => {
                    if (data.code == 0) {
                        fetchData();
                        showMessage('Leave request submitted successfully!','success');
                    } else {
                        showMessage('Leave request submitted failed!', 'error');
                    }
                })
                .catch(error => {
                    showMessage('Leave request submitted error!', 'error');
                });
        } catch (error) {
            showMessage('server error', 'error');
        }
        closeLeaveModal();
    }

    // Function for class hour statistics (dummy function, implement your own logic)
    function showStatistics() {
        nowpage = "statistics";
        document.getElementById('courseDiv').style.display = 'none';
        document.getElementById('Statistics').style.display = 'block';

        document.getElementById('static_date').style.removeProperty('display');
        document.getElementById('course_date').style.display = 'none';
    }
    function hideStatistics() {
        nowpage = "course";
        document.getElementById('courseDiv').style.display = 'block';
        document.getElementById('Statistics').style.display = 'none';

        document.getElementById('static_date').style.display = 'none';
        document.getElementById('course_date').style.removeProperty('display');
    }
    function hideDetail() {
        nowpage = "course";
        current_course = null;
        current_eventId = "";
        document.getElementById('courseDiv').style.display = 'block';
        document.getElementById('courseDetails').style.display = 'none';

        document.getElementById('static_date').style.display = 'none';
        document.getElementById('course_date').style.removeProperty('display');
    }

    // 课时统计
    async function calculateStatistics() {
        let sDate = new Date(document.getElementById('startDate').value);
        let eDate = new Date(document.getElementById('endDate').value);

        if (isNaN(sDate) || isNaN(eDate) || sDate > eDate) {
            showMessage('Please enter valid start and end dates', 'warning');
            return;
        }
        sDate = document.getElementById('startDate').value;
        eDate = document.getElementById('endDate').value

        // get the total duration of all courses
        try {
            document.getElementById('totalDuration').textContent = `Total Duration: 0.0 hours`;
            const TotalList = document.getElementById('TotalList');
            TotalList.innerHTML = '';

            const response = await fetch(url + '/total/getdatabysubid', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ subid, sDate, eDate })
            });

            const data = await response.json();
            if (data.code !== 0) {
                showMessage('server error', 'error');
                return;
            }

            const teacherDurations = data.data.find(item => item.type === 'teacher');
            if (teacherDurations) {
                let totalDuration = teacherDurations.duration;
                // const options = { timeZone: 'Asia/Shanghai', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' };
                // const formatter = new Intl.DateTimeFormat('en-US', options);

                teacherDurations.items.forEach(course => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                <td>${course.title}</td>
                <td>${formatDateTime(course.sdate)}</td>
                <td>${formatDateTime(course.edate)}</td>
                <td>${course.hours}</td>
            `;
                    TotalList.appendChild(row);
                });

                document.getElementById('totalDuration').textContent = `Total Duration: ${totalDuration.toFixed(2)} hours`;
            }
        } catch (error) {
            console.error('Error fetching data:', error);
            showMessage('Error fetching data', 'error');
        }
    }

    function printDiv(divId) {
        const divToPrint = document.getElementById(divId);
        const newWin = window.open('', 'Print-Window');
        newWin.document.open();
        newWin.document.write('<html><head><title>Print</title><style>body{font-family: Arial, sans-serif;} table{width: 100%; border-collapse: collapse;} th, td{border: 1px solid #ddd; padding: 10px; text-align: left;} th{background-color: #f2f2f2;} tbody tr:nth-child(even){background-color: #f9f9f9;}</style></head><body onload="window.print()">' + divToPrint.innerHTML + '</body></html>');
        newWin.document.close();
        setTimeout(function () { newWin.close(); }, 10);
    }

    async function showDetails(courseId) {
        nowpage = "details";
        document.getElementById('course_date').style.display = 'none';
        document.getElementById('courseDiv').style.display = 'none';
        document.getElementById('courseDetails').style.display = 'block';

        current_eventId = courseId;

        const response = await fetch(url + '/course/QueryById?id=' + courseId);
        const result = await response.json();

        if (result.code != 0) {
            showMessage('server error', 'error');
        }
        courseData = result.data;
        current_course = courseData;

        document.getElementById('courseName').textContent = courseData.title;
        document.getElementById('courseTime').textContent = formatDateTime(courseData.start_dt) + ' - ' + formatTime(courseData.end_dt);
        document.getElementById('courseLevel').textContent = courseData.class_level;
        document.getElementById('courseType').textContent = courseData.class_category;
        if(courseData.class_category=='wonders'){
            document.getElementById('div_pro').style.display = 'block';
            document.getElementById('unit').value = courseData.unit;
            document.getElementById('week').value = courseData.week;
            document.getElementById('day').value = courseData.day;
        }
        document.getElementById('who').textContent = courseData.who ? replaceCommas(courseData.who) : '';
        document.getElementById('signedup').innerHTML = courseData.signed_up ? replaceCommas(courseData.signed_up) : '';
        document.getElementById('coursetext_preview').textContent = courseData.preview;
        document.getElementById('coursetext_homework').textContent = courseData.homework;

        document.getElementById('uploadedFiles_preview').innerHTML = '';
        document.getElementById('uploadedFiles_homework').innerHTML = '';
        // 加载已上传的文件
        if (courseData.value4) {
            loadUploadedFiles(courseData.value4.split('/'), 'uploadedFiles_preview');
        }
        if (courseData.value5) {
            loadUploadedFiles(courseData.value5.split('/'), 'uploadedFiles_homework');
        }

        displayData(courseData.student);
    }
    function loadUploadedFiles(files, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        files.forEach(filename => {
            if (filename === '') return;
            const fileItem = document.createElement('div');
            fileItem.classList.add('uploaded-file');
            fileItem.innerHTML = `
            <span><a href="/classroom/download/${filename}" target="_blank">${subStrFilename(filename)}</a></span>
            <i class="fas fa-trash delete-icon" onclick="deleteFile('${filename}', '${containerId}')"></i>
        `;
            container.appendChild(fileItem);
        });
    }
 
    function displayData(data) {
        // studentAttendance
        const studentAttendance = document.getElementById('studentAttendance');
        studentAttendance.innerHTML = `<div style="display: flex; align-items: center; ">
                    <div style="width: 4px; height: 24px; background-color: #2F51FF; "></div>
                        <span style="padding: 0 3px; color: #2F51FF; font-weight: bold">Student attendance</span>
                        <span style="padding: 0 3px;color: #3f3f43;font-weight: bold;margin-left: auto;font-size: 12px;">Courses Students(${data.length})</span>
                    </div>`;

        const studentList = document.getElementById('studentList');
        studentList.innerHTML = `<div style="display: flex; align-items: center; ">
                    <div style="width: 4px; height: 24px; background-color: #2F51FF; "></div>
                        <span style="padding: 0 3px; color: #2F51FF; font-weight: bold">Student evaluation</span>
                    </div>`;
        data.forEach((student, i) => {
            const scode = student.id;
            if (scode == '' || student.name == '') return;
            const studentItem = document.createElement('div');
            studentItem.classList.add('rating-container');
            studentItem.id = scode;

            // 学生考勤
            {
                const studentAttendanceItem = document.createElement('div');
                studentAttendanceItem.classList.add('student_att');
                // <span class="taster">taster</span>
                studentAttendanceItem.innerHTML = `
                    <div class="student">
                        <div class="student-info">
                            <div class="student-name">
                                ${replaceNumberToNull(student.name)}<br>
                                <span class="status">${student.code}</span>
                            </div>
                        </div>
                        <div class="attendance-status">
                            <select id= "select_${scode}" value="${student.state}" onchange="confirmHandleStatusChange('${scode}','${student.name}', this.value)">
                                 <option value="0">&#9989; Normal</option>
                                <option value="1">&#128337; Late</option>
                                <option value="9">&#10060; Absence</option>
                            </select>
                        </div>
                    </div>
                `;
                studentAttendance.appendChild(studentAttendanceItem);
            }

            const studentInfo = document.createElement('div');
            studentInfo.addEventListener('click', () => toggleDetails(scode));
            studentInfo.classList.add('dropdown');
            if (student.value2 == '1') {
                studentInfo.innerHTML += `<div class="new-badge-stu">New</div>`;
            }else if(student.value2 == '2') {
                studentInfo.innerHTML += `<div class="new-badge-stu">Modify</div>`;
            }
            if (i == 0) {
                studentInfo.innerHTML += `
                <span >${replaceNumberToNull(student.name)}</span>
                <i class="fas fa-angle-right rotated" id="arrow_${scode}"></i>
            `;
            } else {
                studentInfo.innerHTML += `
                <span >${replaceNumberToNull(student.name)}</span>
                <i class="fas fa-angle-right" id="arrow_${scode}"></i>
            `;
            }
            const studentDetails = document.createElement('div');
            if (i == 0) {
                studentDetails.classList.add('details');
            } else {
                studentDetails.classList.add('details', 'hidden');
            }
            studentDetails.id = `details_${scode}`;

            const listening = document.createElement('div');
            listening.classList.add('rating-item');
            listening.innerHTML = `
                <span style="width:80px">Listening</span>
                <div class="stars" data-rating="${student.read}" data-category="listening" data-code="${scode}">
                    <span class="star ${student.read >= 1 * 20 ? 'selected' : ''}">&#9733;</span>
                    <span class="star ${student.read >= 2 * 20 ? 'selected' : ''}">&#9733;</span>
                    <span class="star ${student.read >= 3 * 20 ? 'selected' : ''}">&#9733;</span>
                    <span class="star ${student.read >= 4 * 20 ? 'selected' : ''}">&#9733;</span>
                    <span class="star ${student.read >= 5 * 20 ? 'selected' : ''}">&#9733;</span>
                </div>
                <span class="score score_read" >${student.read}%</span>
            `;
            const stars1 = listening.querySelectorAll('.stars');
            stars1.forEach(starContainer => {
                starContainer.addEventListener('click', (e) => {
                    const category = starContainer.getAttribute('data-category');
                    const selectedStar = e.target;
                    const starIndex = Array.from(starContainer.children).indexOf(selectedStar) + 1;

                    // Update the star selection visually
                    updateStars(starContainer, starIndex);

                    // Update the score
                    listening.getElementsByClassName(`score`)[0].textContent = starIndex * 20 + '%';
                });
            });

            const readingWriting = document.createElement('div');
            readingWriting.classList.add('rating-item');
            readingWriting.innerHTML = `
                <span style="width:80px">Reading/Writing</span>
                <div class="stars" data-rating="${student.write}" data-category="reading-writing" data-code="${scode}">
                    <span class="star ${student.write >= 1 * 20 ? 'selected' : ''}">&#9733;</span>
                    <span class="star ${student.write >= 2 * 20 ? 'selected' : ''}">&#9733;</span>
                    <span class="star ${student.write >= 3 * 20 ? 'selected' : ''}">&#9733;</span>
                    <span class="star ${student.write >= 4 * 20 ? 'selected' : ''}">&#9733;</span>
                    <span class="star ${student.write >= 5 * 20 ? 'selected' : ''}">&#9733;</span>
                </div>
                <span class="score score_write">${student.write}%</span>
            `;
            const stars2 = readingWriting.querySelectorAll('.stars');
            stars2.forEach(starContainer => {
                starContainer.addEventListener('click', (e) => {
                    const category = starContainer.getAttribute('data-category');
                    const selectedStar = e.target;
                    const starIndex = Array.from(starContainer.children).indexOf(selectedStar) + 1;

                    // Update the star selection visually
                    updateStars(starContainer, starIndex);

                    // Update the score
                    readingWriting.getElementsByClassName(`score`)[0].textContent = starIndex * 20 + '%';
                });
            });

            const focus = document.createElement('div');
            focus.classList.add('rating-item');
            focus.innerHTML = `
                <span style="width:80px">Focus</span>
                <div class="stars" data-rating="${student.level}" data-category="focus" data-code="${scode}">
                    <span class="star ${student.level >= 1 * 20 ? 'selected' : ''}">&#9733;</span>
                    <span class="star ${student.level >= 2 * 20 ? 'selected' : ''}">&#9733;</span>
                    <span class="star ${student.level >= 3 * 20 ? 'selected' : ''}">&#9733;</span>
                    <span class="star ${student.level >= 4 * 20 ? 'selected' : ''}">&#9733;</span>
                    <span class="star ${student.level >= 5 * 20 ? 'selected' : ''}">&#9733;</span>
                </div>
                <span class="score score_level">${student.level}%</span>
            `;
            const stars3 = focus.querySelectorAll('.stars');
            stars3.forEach(starContainer => {
                starContainer.addEventListener('click', (e) => {
                    const category = starContainer.getAttribute('data-category');
                    const selectedStar = e.target;
                    const starIndex = Array.from(starContainer.children).indexOf(selectedStar) + 1;

                    // Update the star selection visually
                    updateStars(starContainer, starIndex);

                    // Update the score
                    focus.getElementsByClassName(`score`)[0].textContent = starIndex * 20 + '%';
                });
            });

            let homewk = null;
            if (student.homework && student.homework != "undefined") {
                homewk = document.createElement('div');
                homewk.classList.add('rating-item');
                homewk.innerHTML = ` <span style="width:80px">Homework</span><a href="/classroom/download/${student.homework}" target="_blank">${subStrFilename(student.homework)}</a></span></a>`;
            }


            const commentBox = document.createElement('div');
            commentBox.classList.add('comment-box');
            commentBox.innerHTML = `
                <label>Comment</label>
                <textarea id="comment_${scode}" maxlength="200">${student.evaluate}</textarea>
                <div class="char-counter">
                    <span id="charCount_${scode}">${student.evaluate.length}</span>/200
                </div>
            `;
            commentBox.querySelector('textarea').oninput = (event) => handleComment(event, scode);
            // Character count for the comment box

            studentDetails.appendChild(listening);
            studentDetails.appendChild(readingWriting);
            studentDetails.appendChild(focus);
            if (homewk) {
                studentDetails.appendChild(homewk);
            }

            studentDetails.appendChild(commentBox);

            studentItem.appendChild(studentInfo);
            studentItem.appendChild(studentDetails);

            studentList.appendChild(studentItem);
        });
        // 页面加载完毕后设置radio选中状态
        data.forEach(stu => {
            document.getElementById('select_' + stu.id).value = stu.state;
        });
    }

    // 截取文件名，保持后缀
    function subStrFilename(filename) {
        const extension = filename.substring(filename.lastIndexOf('.'));
        const name = filename.substring(0, filename.lastIndexOf('.'));
        if (name.length > 35) {
            return '...' + name.substring(name.length - 5) + extension;
        }
        return filename;
    }
    function checkfile() {
        document.getElementById('fileUpload').click();
    }
    function uploadFile() {
        const files = document.getElementById('fileUpload').files;
        const uploadedFilesContainer = document.getElementById('uploadedFiles_' + filetype_check);
        const existingFiles = uploadedFilesContainer.children.length;

        if (existingFiles + files.length > 2) {
            showMessage('You can upload up to two attachments only.', 'warning');
            return;
        }
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const fileId = 'file-' + Date.now() + '-' + i;

            // 校验文件大小不能超过10MB
            if (file.size > 10 * 1024 * 1024) {
                showMessage('File size should not exceed 10MB.', 'warning');
                return;
            }
            // 创建 FormData 对象
            const formData = new FormData();
            formData.append('file', file);

            // 向服务器发送文件
            fetch(url+'/upload', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json()) // 假设服务器返回JSON
                .then(result => {
                    if (result.code !== 0) {
                        showMessage('Failed to upload file.', 'error');
                        return;
                    }
                    // 显示已上传文件
                    const fileElement = document.createElement('div');
                    fileElement.className = 'uploaded-file';
                    fileElement.id = fileId;
                    fileElement.innerHTML = `
                        <span><a href="/classroom/download/${result.data.filePath}" target="_blank" id="${result.data.filePath}">${subStrFilename(result.data.filePath)}</a></span>
                        <i class="fas fa-trash delete-icon" onclick="deleteFile('${fileId}', '${result.data.filePath}')"></i>
                    `;
                    uploadedFilesContainer.appendChild(fileElement);
                })
                .catch(error => {
                    showMessage('Failed to upload file.', 'error');
                    console.error('Error:', error);
                });
        }
    }

    function deleteFile(fileId, filename) {
        // 向服务器发送删除请求
        fetch(url+'/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ filename: filename })
        })
            .then(response => response.json()) // 假设服务器返回JSON
            .then(result => {
                if (result.code == 0) {
                    // 删除前端显示的文件
                    const fileElement = document.getElementById(fileId);
                    fileElement.parentNode.removeChild(fileElement);
                } else {
                    showMessage('Failed to delete file.', 'error');
                }
            })
            .catch(error => {
                showMessage('Failed to delete file.', 'error');
                console.error('Error:', error);
            });
    }

    async function fetchData() {
        try {
            document.getElementById('selectAll').checked = false;
            const selectedDate = document.getElementById('selectedDate');
            current_date = selectedDate.value;
            const response = await fetch(url + '/course/GetData', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ date: current_date, subid })
            });
            const result = await response.json();

            if (result.code != 0) {
                showMessage('server error', 'error');
            }
            const courseList = document.getElementById('courseList');
            courseList.innerHTML = '';
            today_course = result.data;

            if (result.data.length == 0) {
                const courseItem = document.createElement('div');
                courseItem.classList.add('course-item');
                courseItem.textContent = "You didn't schedule any classes today, have a great time！！！";
                courseList.appendChild(courseItem);
                return;
            }

            result.data.forEach((course, index) => {
                const courseItem = document.createElement('div');
                courseItem.id = "div_" + course.id;
                courseItem.classList.add('course-item');
                if (course.attend == 9) {
                    courseItem.classList.add('course-item-absent');
                }
                if (course.class_category=='writing') {
                    courseItem.innerHTML += `<div class="course-icon"><img src="data:image/png;base64,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" class="icon"></div>`;
                } else {
                    courseItem.innerHTML += `<div class="course-icon"><img src="data:image/png;base64,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" class="icon"></div>`;
                }
                //  else {
                //     courseItem.innerHTML += `<div class="course-icon">💻</div>`;
                // }
                const leaveCheckCss = isLeaveCheck ? 'leaveHide' : '';
                
                if (course.value2 == '1') {
                    courseItem.innerHTML +=
                    `<div class="course-info">
                    <h4 onclick="showDetails('${course.id}')" class="${course.isleave ? 'text_dcro' : ''}">${course.title}</h4>
                    <p><i class="fas fa-clock" title="course time"></i>&nbsp;&nbsp;${formatTime(course.start_dt)} ~ ${formatTime(course.end_dt)}
                            </p>
                    <p><i class="fas fa-user" title="student name"></i>&nbsp;&nbsp;${course.who ? replaceCommas(course.who) : ''}</p>
                    <p class="rlable ${leaveCheckCss}"><i class="fas fa-plus add-course" title="singned up"></i>&nbsp;&nbsp;${course.signed_up ? replaceCommas(course.signed_up) : ''}<label class="accept"><input type="radio" name="attendance_${course.id}" value="1" onchange="confirmAttendanceChange('${course.id}','1')">Accept</label>
                        <label class="refuse"><input type="radio" name="attendance_${course.id}" value="9" onchange="confirmAttendanceChange('${course.id}','9')">Decline</label></p>
                    </div>
                    <div class="new-badge">New</div>`;
                }else if (course.value2 == '2') {
                    courseItem.innerHTML +=
                    `<div class="course-info">
                    <h4 onclick="showDetails('${course.id}')" class="${course.isleave ? 'text_dcro' : ''}">${course.title}</h4>
                    <p><i class="fas fa-clock" title="course time"></i>&nbsp;&nbsp;${formatTime(course.start_dt)} ~ ${formatTime(course.end_dt)}
                            </p>
                    <p><i class="fas fa-user" title="student name"></i>&nbsp;&nbsp;${course.who ? replaceCommas(course.who) : ''}</p>
                    <p class="rlable ${leaveCheckCss}"><i class="fas fa-plus add-course" title="singned up"></i>&nbsp;&nbsp;${course.signed_up ? replaceCommas(course.signed_up) : ''}<label class="accept"><input type="radio" name="attendance_${course.id}" value="1" onchange="confirmAttendanceChange('${course.id}','1')">Accept</label>
                        <label class="refuse"><input type="radio" name="attendance_${course.id}" value="9" onchange="confirmAttendanceChange('${course.id}','9')">Decline</label></p>
                    </div>
                    <div class="new-badge">Modified</div>`;
                }else{
                    courseItem.innerHTML +=
                    `<div class="course-info">
                    <h4 onclick="showDetails('${course.id}')" class="${course.isleave ? 'text_dcro' : ''}">${course.title}</h4>
                    <p><i class="fas fa-clock" title="course time"></i>&nbsp;&nbsp;${formatTime(course.start_dt)} ~ ${formatTime(course.end_dt)}
                            </p>
                    <p><i class="fas fa-user" title="student name"></i>&nbsp;&nbsp;${course.who ? replaceCommas(course.who) : ''}</p>
                    <p class="rlable ${leaveCheckCss}"><i class="fas fa-plus add-course" title="singned up"></i>&nbsp;&nbsp;${course.signed_up ? replaceCommas(course.signed_up) : ''}</p>
                    </div>`;
                }
                courseItem.innerHTML += `<div class="course-arrow ${leaveCheckCss}" onclick="showDetails('${course.id}')"><i class="fas fa-angle-right"></i></div>`;

                const isleaveCheckCss2 = isLeaveCheck ? 'leaveShow' : 'leaveHide';
                if(course.isleave){
                    courseItem.innerHTML += `<input type="checkbox" checked disabled class="courseCheckBox ${isleaveCheckCss2}" id="leave_${course.id}" value="${course.id}">`;
                }else{
                    courseItem.innerHTML += `<input type="checkbox" class="courseCheckBox ${isleaveCheckCss2}" id="leave_${course.id}" value="${course.id}">`;
                }
                courseList.appendChild(courseItem);
            });

            // 页面加载完毕后设置radio选中状态
            result.data.forEach(course => {
                const attendanceRadio = document.querySelector(`input[name="attendance_${course.id}"][value="${course.attend}"]`);
                if (attendanceRadio) {
                    attendanceRadio.checked = true;
                }
            });
        } catch (error) {
            console.error('There has been a problem with your fetch operation:', error);
        }
    }

    async function fetchNewMessages() {
        const response = await fetch(url + '/message?code=' + subid, {
            method: 'GET'
        });
        const result = await response.json();

        if (result.code != 0) {
            showMessage('Failed to fetch new messages', 'error');
            return;
        }
        messages = [];
        result.data.forEach(item => {
            const newMessage = {
                id: item.id,
                text: item.msg,
                url: item.url,
                time: item.create_date
            };
            messages.push(newMessage);
        });

        // 存储消息到 localStorage
        localStorage.setItem('messages', JSON.stringify(messages));

        updateNotificationCount(messages.length);
    }

    async function changeDate(days) {
        const dateInput = document.getElementById('selectedDate');
        const currentDate = new Date(dateInput.value);
        currentDate.setDate(currentDate.getDate() + days);
        dateInput.value = currentDate.toISOString().split('T')[0];
        await fetchData();
    }

    // 显示或隐藏消息弹出框
    function toggleNotificationPopup() {
        const messages = JSON.parse(localStorage.getItem('messages')) || [];
        if(messages.length == 0){
            showMessage('No new messages', 'info');
            return;
        }
        const popup = document.getElementById('notification-popup');
        if (popup.style.display === 'none' || popup.style.display === '') {
            loadNotifications();
            popup.style.display = 'block';
        } else {
            popup.style.display = 'none';
        }
    }

    // 更新消息数
    function updateNotificationCount(count) {
        if(count>0){
            document.getElementById('notification-count').style.display = 'inline';
            document.getElementById('notification-count').innerText = count;
        }else{
            document.getElementById('notification-count').style.display = 'none';
        }
    }
    // 加载消息记录
    function loadNotifications() {
        const messages = JSON.parse(localStorage.getItem('messages')) || [];
        const notificationList = document.getElementById('notification-list');
        notificationList.innerHTML = '';
        messages.forEach(message => {
            const listItem = document.createElement('li');
            listItem.innerHTML = `<a onclick="readMsg('${message.url}', '${message.id}')" style="cursor: pointer;">${message.text}</a>`;// &nbsp;&nbsp;<small>${message.time}</small>
            notificationList.appendChild(listItem);
        });
    }

    function readMsg(date, id){
        if(date=='')
            return;
        let messages = JSON.parse(localStorage.getItem('messages')) || [];
        messages = messages.filter(message => message.id != id);
        localStorage.setItem('messages', JSON.stringify(messages));
        loadNotifications();
        if(messages.length == 0){
            document.getElementById('notification-popup').style.display = 'none';
        }
        const selectedDate = document.getElementById('selectedDate');
        selectedDate.value = date;
        fetchData();

        fetch(url + '/message/read/' + id, {
            method: 'GET'
        });
    }

    function toggleDetails(scode) {
        const details = document.getElementById('details_' + scode);
        const arrow = document.getElementById('arrow_' + scode);

        if (details.classList.contains('hidden')) {
            details.classList.remove('hidden');
            arrow.classList.add('rotated');
        } else {
            details.classList.add('hidden');
            arrow.classList.remove('rotated');
        }
    }

    function handleComment(e, scode) {
        console.log('handleComment');
        const comment = e.target.value;
        const charCount = document.getElementById('charCount_' + scode);
        charCount.textContent = comment.length;
    }

    function updateStars(container, rating) {
        const stars = container.children;
        for (let i = 0; i < stars.length; i++) {
            stars[i].classList.remove('selected');
            if (i < rating) {
                stars[i].classList.add('selected');
            }
        }
    }

    async function Save() {
        // 保存学生评价
        const studentInfos = [];
        const students = document.getElementById('studentList').children;
        for (let i = 1; i < students.length; i++) {
            const student = students[i];
            const code = student.id;
            const read = student.getElementsByClassName('score_read')[0].textContent.replace('%', '');
            const write = student.getElementsByClassName('score_write')[0].textContent.replace('%', '');
            const level = student.getElementsByClassName('score_level')[0].textContent.replace('%', '');
            const evaluate = document.getElementById('comment_' + code).value;

            studentInfos.push({ code, read, write, level, evaluate });
        }

        const preview = document.getElementById('coursetext_preview').value;
        const homework = document.getElementById('coursetext_homework').value;
        let previewfiles = '';
        const previewFiles = Array.from(document.querySelectorAll('#uploadedFiles_preview .uploaded-file'));
        previewFiles.forEach(file => {
            const fileName = file.children[0].childNodes[0].id;
            previewfiles += fileName + '/';
        });

        const homeworkFiles = Array.from(document.querySelectorAll('#uploadedFiles_homework .uploaded-file'));
        let homeworkfiles = '';
        homeworkFiles.map(file => {
            const fileName = file.children[0].childNodes[0].id;
            homeworkfiles += fileName + '/';
        });

        let unit = document.getElementById('unit').value;
        let week = document.getElementById('week').value;
        let day = document.getElementById('day').value;

        const response = await fetch(url + '/course/SaveInfo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id: current_eventId, students: studentInfos, preview, homework, previewfiles, homeworkfiles, unit, week, day })
        });
        const result = await response.json();

        if (result.code != 0) {
            showMessage('Feedback submitted faild', 'error');
        } else {
            showMessage('Feedback submitted successfully', 'success');
        }
    }

    function confirmHandleStatusChange(code, name, state) {
        const originalValue = current_course.student.find(st => st.id == code).state;
        if(originalValue==1){
            if(state == 0){
                document.getElementById('select_' + code).value = originalValue;
                showMessage('Cannot be rolled back', 'warning');
                return;
            }
        }
        let msg = "Please confirm to report the student as late. This change can not be reverted.  We will immediately send a text message reminder to parents. ";
        if (state == 9) {
            msg = "Please confirm you want to report absent student.  This change can not be reverted.  If no student in the class, you can leave the meeting now.";
        } 
        showConfirm(msg, function(confirmation){
            if (confirmation) {
                handleStatusChange(code, name, state);
            } else {
                // 如果用户取消确认，则恢复原来的选中状态
                document.getElementById('select_' + code).value = originalValue;
            }
        });
    }

    // Example function to handle status change
    async function handleStatusChange(code, name, state) {
        console.log(`Studentcode: ${code}, Status: ${state}`);
        const response = await fetch(url + '/course/SignStudentStatus', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id: current_eventId, code, name, state })
        });
        const result = await response.json();

        if (result.code != 0) {
            showMessage(`Failed to reported student ${replaceNumberToNull(name)}'s ${state == '1' ? 'lateness' : 'absence'} information!`, 'error');
            const originalValue = current_course.student.find(st => st.id == code).state;
            document.getElementById('select_' + code).value = originalValue;
        } else {
            current_course.student.find(st => st.id == code).state = state;
            showMessage(`Successfully reported student ${replaceNumberToNull(name)}'s ${state == '1' ? 'lateness' : 'absence'} information!`, 'success');
            if(state == 9){
                showDetails(current_course.id);
            }
        }
    }

    function confirmAttendanceChange(courseId, value) {
        let msg = "Are you sure you will attend?";
        if (value == 9) {
            msg = "Are you sure you want to decline the new course? ";
        }
        const confirmation = showConfirm(msg, function(confirmation){
            if (confirmation) {
                handleAttendanceChange(courseId, value);
            } else {
                // 如果用户取消确认，则恢复原来的选中状态
                const originalValue = today_course.find(course => course.id == courseId).attend;
                document.querySelector(`input[name="attendance_${courseId}"][value="${originalValue}"]`).checked = true;
            }
        });
    }

    async function handleAttendanceChange(courseId, attend) {
        const response = await fetch(url + '/course/EditData', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id: courseId, attend: attend })
        });
        const result = await response.json();

        if (result.code != 0) {
            showMessage(`Failed to report leave request!`, 'error');
            // 如果更新teamup失败，则恢复原来的选中状态
            const originalValue = today_course.find(course => course.id == courseId).attend;
            document.querySelector(`input[name="attendance_${courseId}"][value="${originalValue}"]`).checked = true;
        } else {
            const original = today_course.find(course => course.id == courseId);
            original.attend = attend;
            if (attend != 9) {
                document.getElementById("div_" + courseId).classList.remove('course-item-absent');
            } else {
                document.getElementById("div_" + courseId).classList.add('course-item-absent');
            }

            fetchData();
            showMessage(`Successfully reported leave request!`, 'success');
        }
    }


    function formatDate(date) {
        if (date == undefined) {
            date = new Date();
        } else {
            date = new Date(date);
        }
        const timeZone = new Date().toLocaleTimeString('en-us', { timeZoneName: 'short' }).split(' ')[2];//Intl.DateTimeFormat().resolvedOptions().timeZone;
        if (timezoneSet != timeZone) {
            date = new Date(date.toLocaleString('en-US', { timeZone: timezoneSet }));
        }
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    function formatDateTime(date) {
        if (date == undefined) {
            date = new Date();
        } else {
            date = new Date(date);
        }
        const timeZone = new Date().toLocaleTimeString('en-us', { timeZoneName: 'short' }).split(' ')[2];//Intl.DateTimeFormat().resolvedOptions().timeZone;
        if (timezoneSet != tzSet[timeZone]) {
            date = new Date(date.toLocaleString('en-US', { timeZone: timezoneSet }));
        }
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}`;
    }
    function formatTime(date) {
        if (date == undefined) {
            date = new Date();
        } else {
            date = new Date(date);
        }
        const timeZone = new Date().toLocaleTimeString('en-us', { timeZoneName: 'short' }).split(' ')[2];//Intl.DateTimeFormat().resolvedOptions().timeZone;
        if (timezoneSet != tzSet[timeZone]) {
            date = new Date(date.toLocaleString('en-US', { timeZone: timezoneSet }));
        }

        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
    }

    function replaceNumberToNull(str) {
        if (!str) {
            return '';
        }
        let resStr = str.split(/[,，]+/).map(x => {
            let code = x.match(/\d{8,10}/) || '';
            // 找到以L开头后面加1位数字的字符串
            let code2 = x.match(/L\d{1,2}/) || '';
            if(code){
                x= x.split(code)[0].trim()+" "+code2;
            }else{
                if(code2){
                    x = x.split(code2)[0].trim()+" "+code2;
                }
            }
            return x;
        }).join(',');
        resStr = resStr.replace(',,', ',').replace(/,$/, '').replace(/^,/, '');

        return resStr;
    }

    function replaceCommas(str) {
        if (!str) {
            return '';
        }
        let resStr = str.split(/[,，]+/).map(x => {
            let code = x.match(/\d{8,10}/) || '';
            // 找到以L开头后面加1位数字的字符串
            let code2 = x.match(/L\d{1,2}/) || '';
            if(code){
                x= x.split(code)[0].trim()+" "+code2;
            }else{
                if(code2){
                    x = x.split(code2)[0].trim()+" "+code2;
                }
            }
            return x;
        }).join(',');
        resStr = resStr.replace(',,', ',').replace(/,$/, '').replace(/^,/, '');

        return resStr;
    }
</script>