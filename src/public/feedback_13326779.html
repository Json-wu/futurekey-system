<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher management system</title>
    <style>
        body {
            margin: 0;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(to bottom, #6a00ff, #b2dfff);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow-y: hidden;
            min-width: 320px;
        }

        .container {
            background: linear-gradient(to bottom, rgba(255, 0, 0, 0.5), rgba(0, 0, 255, 0.5));
            /* color: #ffffff; */
            width: 360px;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0px 4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .welcome-message {
            font-size: 16px;
            color: #ffffff;
        }

        .notification-icon {
            font-size: 24px;
            color: #007bff;
            cursor: pointer;
            position: relative;
            display: inline-block;
        }

        .notification-icon .badge {
            position: absolute;
            right: -8px;
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 6px 9px 6px 4px;
            font-size: 5px;
            width: 5px;
        }

        .notification-popup {
            display: none;
            position: absolute;
            top: 50px;
            right: 0;
            width: 200px;
            max-height: 400px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #ccc;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .notification-popup ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .notification-popup li {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 10px;
        }

        .notification-popup li:last-child {
            border-bottom: none;
        }

        .notification-popup li a {
            color: #333;
            text-decoration: none;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-size: 14px;
            margin-bottom: 8px;
            color: #ffffff;
        }

        .input-group input {
            width: 94%;
            padding: 10px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .input-group select {
            width: 94%;
            padding: 10px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .input-group_detail {
            width: 80%;
            height: 20px;
            margin-top: 10px;
            margin-left: auto;
            margin-right: auto;
            background-color: #ffffff;
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 10px;
        }

        .input-group_detail label {
            width: 100px;
            display: block;
            font-size: 12px;
            color: #6b6969;
            /* margin-bottom: 8px; */
            margin-right: 10px;
            text-align: right;
        }

        .input-group_detail span {
            display: block;
            font-size: 12px;
            color: #080808;
            /* margin-bottom: 8px; */
            margin-right: 10px;
        }

        .input-group_detail textarea {
            width: 80%;
            display: block;
            font-size: 12px;
            color: #080808;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            resize: none;
        }

        .date-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .date-buttons button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            width: 50px;
            /* Ë∞ÉÊï¥ÊåâÈíÆÂÆΩÂ∫¶ */
            height: 50px;
            /* Ë∞ÉÊï¥ÊåâÈíÆÈ´òÂ∫¶ */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .date-buttons button:hover {
            background-color: #0056b3;
        }

        .date-buttons input[type="date"] {
            flex-grow: 1;
            margin: 0 10px;
            padding: 10px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .course-list {
            /* margin-top: 20px; */
            max-height: 300px;
            /* ËÆæÁΩÆÊúÄÂ§ßÈ´òÂ∫¶ */
            overflow-y: auto;
            /* ÂêØÁî®ÂûÇÁõ¥ÊªöÂä® */
        }

        .course-item {
            background-color: #f3f6ff;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 15px auto;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            cursor: pointer;
            /* Ê∑ªÂä†Èº†Ê†áÊåáÈíàÊ†∑Âºè */
        }

        .course-icon {
            width: 40px;
            height: 40px;
            background-color: #ffcc99;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 10px;
            font-size: 18px;
        }

        .course-info {
            flex: 1;
        }

        .course-info h4 {
            margin: 0;
            font-size: 16px;
            color: #333;
        }

        .course-info p {
            margin: 5px 0;
            font-size: 14px;
            color: #999;
        }

        .courseinfo-ico {
            background-color: #ffcc99;
        }

        .course-arrow {
            font-size: 18px;
            color: #007bff;
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .date-buttons button {
            background-color: #007bff;
            color: white;
            text-align: center;
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            width: 30%;
            /* Á°Æ‰øù‰∏§‰∏™ÊåâÈíÆÂú®‰∏ÄË°åÂÜÖ */
        }

        .stats-button,
        .leave-button {
            background-color: #007bff;
            color: white;
            text-align: center;
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            width: 48%;
            /* Á°Æ‰øù‰∏§‰∏™ÊåâÈíÆÂú®‰∏ÄË°åÂÜÖ */
        }

        .date-buttons button:hover,
        .stats-button:hover,
        .leave-button:hover {
            background-color: #0056b3;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: linear-gradient(to bottom, rgba(106, 0, 255, 0.8), rgba(178, 223, 255, 0.8));
            /* background-color: white; */
            padding: 20px;
            border-radius: 10px;
            width: 300px;
            text-align: center;
        }

        .modal-content select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .modal-content button {
            margin-top: 20px;
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        .modal-content button:hover {
            background-color: #218838;
        }

        .close {
            float: right;
            font-size: 20px;
            cursor: pointer;
        }

        .close:hover {
            color: red;
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .button-group button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            flex: 1;
            margin: 0 5px;
        }

        .button-group button:hover {
            background-color: #0056b3;
        }

        .upload-container {
            text-align: left;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
            max-width: 600px;
        }

        .upload-icon {
            font-size: 36px;
            color: #007bff;
        }

        .upload-btn-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .btn {
            border: 2px solid #007bff;
            color: #007bff;
            background-color: #ffffff;
            padding: 10px 20px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background-color: #007bff;
            color: #ffffff;
        }

        .upload-btn-wrapper input[type="file"] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }

        .file-name {
            font-size: 14px;
            color: #666;
            flex: 1;
            /* Êñá‰ª∂ÂêçÈÉ®ÂàÜÂ°´Êª°Ââ©‰ΩôÁ©∫Èó¥ */
            white-space: nowrap;
            /* Èò≤Ê≠¢Êñá‰ª∂ÂêçÊç¢Ë°å */
            overflow: hidden;
            text-overflow: ellipsis;
            /* Ë∂ÖÈïøÊñá‰ª∂ÂêçÊòæÁ§∫ÁúÅÁï•Âè∑ */
        }

        .status {
            font-size: 14px;
            color: #28a745;
            margin-top: 10px;
        }


        .table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table,
        th,
        td {
            border: 1px solid #ddd;
        }

        th,
        td {
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        /* Custom scrollbar styles */
        .table-container::-webkit-scrollbar {
            width: 12px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 6px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Date input styles */
        .date-input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            margin-right: 10px;
        }

        .rating-container {
            width: 77%;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 10px 20px 10px 20px;
            margin: 10px auto 20px auto;
        }

        .dropdown {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            cursor: pointer;
        }

        .arrow {
            transition: transform 0.5s;
        }

        .arrow.rotated {
            transform: rotate(180deg);
        }

        .hidden {
            display: none;
        }

        .rating-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 60px 0 10px;
        }

        .rating-item span {
            font-size: 13px;
        }

        .stars {
            display: flex;
            cursor: pointer;
        }

        .star {
            font-size: 20px !important;
            color: lightgray;
            margin-left: 10px;
        }

        .star.selected {
            color: gold;
        }

        .score {
            font-size: 16px;
            margin-left: 10px;
        }

        .comment-box {
            font-size: 13px;
            margin-left: 10px;
            margin-top: 10px;
        }

        .comment-box textarea {
            width: 95%;
            height: 40px;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            font-size: 13px;
            resize: none;
            margin-top: 10px;
        }

        .char-counter {
            text-align: right;
            font-size: 12px;
            margin-top: 5px;
            color: gray;
        }

        .details {
            margin-top: 20px;
        }

        /* Â™í‰ΩìÊü•ËØ¢ÔºåÁî®‰∫éË∞ÉÊï¥PCÁ´ØÊòæÁ§∫Ê†∑Âºè */
        @media (min-width: 768px) {
            .container {
                width: 600px;
            }

            .input-group input,
            .input-group select {
                width: 100%;
            }

            .notification-popup {
                top: 90px;
            }
        }

        /* Â™í‰ΩìÊü•ËØ¢ÔºåÁî®‰∫éË∞ÉÊï¥ÁßªÂä®Á´ØÊòæÁ§∫Ê†∑Âºè */
        @media (max-width: 767px) {
            .container {
                height: 90vh;
                /* Ë∞ÉÊï¥È´òÂ∫¶‰ª•Â∞ΩÈáèÈì∫Êª°Â±èÂπï */
            }

            .course-list {
                max-height: 420px;
                /* ÁßªÈô§ÊúÄÂ§ßÈ´òÂ∫¶ÈôêÂà∂ */
                flex-grow: 1;
                /* ‰ΩøËØæÁ®ãÂàóË°®Âå∫ÂüüÊãâ‰º∏ */
            }

            .notification-popup {
                top: 75px;
            }
        }
    </style>
    <!-- ÂºïÂÖ• Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
    <div class="container">
        <!-- Top Area -->
        <div class="header">
            <div class="welcome-message"></div>
            <div class="notification-icon" onclick="toggleNotificationPopup()">
                <i class="fas fa-bell"></i>
                <span class="badge" id="notification-count">10</span>
            </div>
            <div class="notification-popup" id="notification-popup">
                <ul id="notification-list"></ul>
            </div>
        </div>
        <!-- Course Management -->
        <div id="courseDiv" style="display: block;">
            <!-- Êó•ÊúüÈÄâÊã©ÂíåÂâç‰∏ÄÂ§©„ÄÅÂêé‰∏ÄÂ§©ÊåâÈíÆ -->
            <div class="date-buttons">
                <button onclick="changeDate(-1)"><i class="fas fa-chevron-left"></i></button>
                <input type="date" id="selectedDate" value="2024-12-02" onchange="fetchData()">
                <button onclick="changeDate(1)"><i class="fas fa-chevron-right"></i></button>
            </div>

            <!-- ÂΩìÂâçÊó∂Âå∫ÊòæÁ§∫ -->
            <div class="input-group">
                <label id="timezone"></label>
            </div>

            <!-- ËØæÁ®ãÂàóË°® -->
            <div class="course-list" id="courseList">
            </div>

            <!-- Â∫ïÈÉ®ÊåâÈíÆ -->
            <div class="button-group">
                <button class="stats-button" onclick="showStatistics()">Lesson time statistics</button>
                <button class="leave-button" onclick="openLeaveModal()">Leave of absence</button>
            </div>
        </div>
        <!-- Course Consumption Statistics -->
        <div id="Statistics" style="display: none;">
            <div class="date-buttons">
                <input type="date" id="startDate" class="date-input">~
                <input type="date" id="endDate" class="date-input">
                <button onclick="calculateStatistics()">statistics</button>
            </div>

            <!-- ËØæÊ∂àÁªüËÆ° -->
            <div id="total">
                <h2>Statistics Result</h2>
                <p id="totalDuration">Total Duration: 0.00 hours</p>
                <div class="table-container">
                    <table border="1">
                        <thead>
                            <tr>
                                <th>Course Name</th>
                                <th>Course Start Time</th>
                                <th>Course End Time</th>
                                <th>Course Duration (hours)</th>
                            </tr>
                        </thead>
                        <tbody id="TotalList">
                            <!-- ËØæÁ®ãÊòéÁªÜÂ∞ÜÂä®ÊÄÅÊèíÂÖ•Âà∞ËøôÈáå -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Â∫ïÈÉ®ÊåâÈíÆ -->
            <div class="button-group">
                <button class="stats-button" onclick="hideStatistics()">back</button>
                <button class="leave-button" onclick="printDiv('total')">print</button>
            </div>
        </div>
        <!-- course details -->
        <div id="courseDetails" style="display: none;">
            <h4>Course Detail</h4>
            <div class="table-container" id="detailDiv">
                <div class="input-group_detail">
                    <label>Course Name:</label>
                    <span id="courseName"></span>
                </div>
                <div class="input-group_detail">
                    <label>Course Time:</label>
                    <span id="courseTime"></span>
                </div>
                <div class="input-group_detail">
                    <label>Time Zone:</label>
                    <span id="courseTimezone"></span>
                </div>
                <div class="input-group_detail">
                    <label>Level:</label>
                    <span id="courseLevel"></span>
                </div>
                <div class="input-group_detail">
                    <label>Type:</label>
                    <span id="courseType"></span>
                </div>
                <div class="input-group_detail">
                    <label>who:</label>
                    <span id="who"></span>
                </div>
                <div class="input-group_detail">
                    <label>Description:</label>
                    <span id="courseDescription"></span>
                </div>
                <div class="input-group_detail">
                    <label>coursePreview:</label>
                    <textarea id="coursePreview"></textarea>
                </div>
                <div class="input-group_detail">
                    <label>courseHomework:</label>
                    <textarea id="courseHomework"></textarea>
                </div>
                <div style="display: flex; align-items: center; margin: 20px 0;">
                    <hr style="flex-grow: 1; border: none; border-top: 1px solid #ccc;">
                    <span style="padding: 0 10px; color: #333;">Â≠¶ÁîüËØÑ‰ª∑</span>
                    <hr style="flex-grow: 1; border: none; border-top: 1px solid #ccc;">
                </div>
               <div id="studentList">
                    <!-- Â≠¶ÁîüËØÑ‰ª∑Â∞ÜÂä®ÊÄÅÊèíÂÖ•Âà∞ËøôÈáå -->
               </div>
                <div class="rating-container">
                    <div class="dropdown" onclick="toggleDetails()">
                        <span>ÂàòÂ∞èÊû´</span>
                        <span id="arrow" class="arrow">&#9660;</span>
                    </div>

                    <div id="details" class="details hidden">
                        <div class="rating-item">
                            <span>Âê¨ËØ¥</span>
                            <div class="stars" data-rating="0" data-category="listening">
                                <span class="star">&#9733;</span>
                                <span class="star">&#9733;</span>
                                <span class="star">&#9733;</span>
                                <span class="star">&#9733;</span>
                                <span class="star">&#9733;</span>
                            </div>
                            <span class="score" id="listening-score">0</span>
                        </div>

                        <div class="rating-item">
                            <span>ËØªÂÜô</span>
                            <div class="stars" data-rating="0" data-category="reading-writing">
                                <span class="star">&#9733;</span>
                                <span class="star">&#9733;</span>
                                <span class="star">&#9733;</span>
                                <span class="star">&#9733;</span>
                                <span class="star">&#9733;</span>
                            </div>
                            <span class="score" id="reading-writing-score">0</span>
                        </div>

                        <div class="rating-item">
                            <span>‰∏ìÊ≥®</span>
                            <div class="stars" data-rating="0" data-category="focus">
                                <span class="star">&#9733;</span>
                                <span class="star">&#9733;</span>
                                <span class="star">&#9733;</span>
                                <span class="star">&#9733;</span>
                                <span class="star">&#9733;</span>
                            </div>
                            <span class="score" id="focus-score">0</span>
                        </div>

                        <div class="comment-box">
                            <label for="comment">ËØÑËØ≠</label>
                            <textarea id="comment" maxlength="200"></textarea>
                            <div class="char-counter">
                                <span id="charCount">0</span>/200
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Â∫ïÈÉ®ÊåâÈíÆ -->
            <div class="button-group">
                <button class="stats-button" onclick="hideDetail()">back</button>
                <button class="leave-button" onclick="printDiv('detailDiv')">print</button>
            </div>
        </div>
    </div>

    <!-- Full-day Leave Modal -->
    <div id="leaveModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeLeaveModal()">&times;</span>
            <h2>Infomation of Leave</h2>
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="leaveReason">Reason:</label>
                <select id="leaveReason">
                    <option value="sick">Sick Leave</option>
                    <option value="personal">Personal Leave</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <input type="hidden" id="leaveCourse" value="">
            <br><br>
            <button onclick="submitLeaveRequest()">Submit</button>
        </div>
    </div>
</body>

</html>
<script>
    const url = "/classroom";
    const subid = '13326779';
    const teacher_name = 'Amanda';
    let current_eventId = "";
    let today_course = [];

    document.addEventListener('DOMContentLoaded', () => {
        const teachName = document.getElementsByClassName('welcome-message')[0];
        teachName.innerText = `Welcome, Teacher ${teacher_name}ÔºÅ`;

        const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        document.getElementById('timezone').innerText = 'timezoneÔºö ' + timeZone;

        const selectedDate = document.getElementById('selectedDate');
        selectedDate.value = formatDate(new Date());
        fetchData();
        fetchNewMessages();

        // Poll for new messages every 30 seconds
        setInterval(fetchNewMessages, 30000);
    });

    // Function to open the leave modal
    function openLeaveModal(course) {
        if (course) {
            document.getElementById('leaveCourse').value = JSON.stringify(course);
        } else {
            // if today is not a class day, the leave date is today
            if (today_course.length == 0) {
                alert("You don't have any classes scheduled today, so there's no need to take a leave!");
                return;
            } else {
                document.getElementById('leaveCourse').value = '';
            }
        }
        document.getElementById('leaveModal').style.display = 'flex';
    }

    // Function to close the leave modal
    function closeLeaveModal() {
        document.getElementById('leaveModal').style.display = 'none';
    }

    // Function to submit the leave request
    function submitLeaveRequest(course) {
        const reason = document.getElementById('leaveReason').value;
        try {
            let course;
            if (document.getElementById('leaveCourse').value != '') {
                course = JSON.parse(document.getElementById('leaveCourse').value);
            }
            let body = {
                code: subid,
                name: teacher_name,
            };
            if (course) {
                body.start_dt = formatDateTime(new Date(course.start_dt));
                body.end_dt = formatDateTime(new Date(course.end_dt));
            } else {
                const selectedDate = document.getElementById('selectedDate');
                const nowTimeDate = new Date(selectedDate.value)
                nowTimeDate.setHours(23, 59, 59, 999)
                body.start_dt = formatDateTime(new Date((new Date(selectedDate.value)).setHours(0, 0, 0, 0)));
                body.end_dt = formatDateTime(new Date((new Date(selectedDate.value)).setHours(23, 59, 59, 999)));
            }
            fetch(url + '/leave/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            }).then(response => response.json())
                .then(data => {
                    if (data.code == 0) {
                        alert('Leave request submitted successfully!');
                    } else {
                        alert(data.msg);
                    }
                })
                .catch(error => {
                    alert('Leave request submitted error!');
                    console.log('Error:', error)
                });


        } catch (error) {
            console.error('There has been a problem with your fetch operation:', error);
        }
        closeLeaveModal();
    }

    // Function for class hour statistics (dummy function, implement your own logic)
    function showStatistics() {
        document.getElementById('courseDiv').style.display = 'none';
        document.getElementById('Statistics').style.display = 'block';
    }
    function hideStatistics() {
        document.getElementById('courseDiv').style.display = 'block';
        document.getElementById('Statistics').style.display = 'none';
    }
    function hideDetail() {
        document.getElementById('courseDiv').style.display = 'block';
        document.getElementById('courseDetails').style.display = 'none';
    }

    // ËØæÊó∂ÁªüËÆ°
    async function calculateStatistics() {
        let sDate = new Date(document.getElementById('startDate').value);
        let eDate = new Date(document.getElementById('endDate').value);

        if (isNaN(sDate) || isNaN(eDate) || sDate >= eDate) {
            alert('Please enter valid start and end dates');
            return;
        }
        sDate = formatDate(sDate);
        eDate = formatDate(eDate);

        // get the total duration of all courses
        try {
            const response = await fetch(url + '/total/getdatabysubid', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ subid, sDate, eDate })
            });

            const data = await response.json();
            if (data.code !== 0) {
                alert('Êü•ËØ¢ËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØ');
                return;
            }
            const teacherDurations = data.data.find(item => item.type === 'teacher');
            if (teacherDurations) {
                let totalDuration = teacherDurations.duration;
                const TotalList = document.getElementById('TotalList');
                TotalList.innerHTML = '';

                // const options = { timeZone: 'Asia/Shanghai', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' };
                // const formatter = new Intl.DateTimeFormat('en-US', options);

                teacherDurations.items.forEach(course => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                <td>${course.title}</td>
                <td>${formatDateTime(new Date(course.sdate))}</td>
                <td>${formatDateTime(new Date(course.edate))}</td>
                <td>${course.hours}</td>
            `;
                    TotalList.appendChild(row);
                });

                document.getElementById('totalDuration').textContent = `Total Duration: ${totalDuration.toFixed(2)} hours`;
            }
        } catch (error) {
            console.error('Error fetching data:', error);
            alert('Error fetching data');
        }
    }

    function printDiv(divId) {
        const divToPrint = document.getElementById(divId);
        const newWin = window.open('', 'Print-Window');
        newWin.document.open();
        newWin.document.write('<html><head><title>Print</title><style>body{font-family: Arial, sans-serif;} table{width: 100%; border-collapse: collapse;} th, td{border: 1px solid #ddd; padding: 10px; text-align: left;} th{background-color: #f2f2f2;} tbody tr:nth-child(even){background-color: #f9f9f9;}</style></head><body onload="window.print()">' + divToPrint.innerHTML + '</body></html>');
        newWin.document.close();
        setTimeout(function () { newWin.close(); }, 10);
    }

    function showDetails(courseData) {
        document.getElementById('courseDiv').style.display = 'none';
        document.getElementById('courseDetails').style.display = 'block';

        current_eventId = courseData.eventId;
        document.getElementById('courseName').textContent = courseData.title;
        document.getElementById('courseTime').textContent = formatDateTime(new Date(courseData.start_dt)) + ' ~ ' + formatDateTime(new Date(courseData.end_dt));
        document.getElementById('courseTimezone').textContent = courseData.tz;
        document.getElementById('courseLevel').textContent = courseData.class_level;
        document.getElementById('courseType').textContent = courseData.class_category;
        document.getElementById('who').textContent = courseData.who ? replaceCommas(courseData.who) : '';
        document.getElementById('courseDescription').textContent = courseData.description;
        document.getElementById('coursePreview').textContent = courseData.coursePreview;
        document.getElementById('courseHomework').textContent = courseData.homework;
        displayData(courseData.student);
    }
    function hideDetails() {
        document.getElementById('courseDiv').style.display = 'block';
        document.getElementById('courseDetails').style.display = 'none';
    }

    function displayData(data) {
        const studentList = document.getElementById('studentList');
        studentList.innerHTML = "";
        data.forEach(student => {
            const scode = student.code;
            const studentItem = document.createElement('div');
            studentItem.classList.add('rating-container');
            studentItem.id = scode;

            const studentInfo = document.createElement('div');
            studentInfo.classList.add('dropdown');
            studentInfo.onclick = () => toggleDetails(scode);
            studentInfo.innerHTML = `
                <span>${student.name}</span>
                <span class="arrow" id="arrow_${scode}">&#9660;</span>
            `;

            const studentDetails = document.createElement('div');
            studentDetails.classList.add('details', 'hidden');
            studentDetails.id = `details_${scode}`;

            const listening = document.createElement('div');
            listening.classList.add('rating-item');
            listening.innerHTML = `
                <span>Listening</span>
                <div class="stars" data-rating="${student.read}" data-category="listening" data-code="${scode}">
                    <span class="star read_${scode} ${student.read >= 1 ? 'selected' : ''}">&#9733;</span>
                    <span class="star read_${scode} ${student.read >= 2 ? 'selected' : ''}">&#9733;</span>
                    <span class="star read_${scode} ${student.read >= 3 ? 'selected' : ''}">&#9733;</span>
                    <span class="star read_${scode} ${student.read >= 4 ? 'selected' : ''}">&#9733;</span>
                    <span class="star read_${scode} ${student.read >= 5 ? 'selected' : ''}">&#9733;</span>
                </div>
                <span class="score">${student.read}</span>
            `;
            listening.querySelector('.read_'+scode).onclick = (event) => handleRating(event, scode);
            const stars = document.querySelectorAll('.stars');
    stars.forEach(starContainer => {
        starContainer.addEventListener('click', (e) => {
            const category = starContainer.getAttribute('data-category');
            const selectedStar = e.target;
            const starIndex = Array.from(starContainer.children).indexOf(selectedStar) + 1;

            // Update the star selection visually
            updateStars(starContainer, starIndex);

            // Update the score
            document.getElementById(`${category}-score`).textContent = starIndex;
        });
    });

            const readingWriting = document.createElement('div');
            readingWriting.classList.add('rating-item');
            readingWriting.innerHTML = `
                <span>Reading/Writing</span>
                <div class="stars2" data-rating="${student.write}" data-category="reading-writing" data-code="${scode}">
                    <span class="star write_${scode} ${student.write >= 1 ? 'selected' : ''}">&#9733;</span>
                    <span class="star write_${scode} ${student.write >= 2 ? 'selected' : ''}">&#9733;</span>
                    <span class="star write_${scode} ${student.write >= 3 ? 'selected' : ''}">&#9733;</span>
                    <span class="star write_${scode} ${student.write >= 4 ? 'selected' : ''}">&#9733;</span>
                    <span class="star write_${scode} ${student.write >= 5 ? 'selected' : ''}">&#9733;</span>
                </div>
                <span class="score">${student.write}</span>
            `;
            readingWriting.querySelector('.write_'+scode).onclick = (event) => handleRating(event, scode);

            const focus = document.createElement('div');
            focus.classList.add('rating-item');
            focus.innerHTML = `
                <span>Focus</span>
                <div class="stars_${scode}" data-rating="${student.level}" data-category="focus" data-code="${scode}">
                    <span class="star level_${scode} ${student.level >= 1 ? 'selected' : ''}">&#9733;</span>
                    <span class="star level_${scode} ${student.level >= 2 ? 'selected' : ''}">&#9733;</span>
                    <span class="star level_${scode} ${student.level >= 3 ? 'selected' : ''}">&#9733;</span>
                    <span class="star level_${scode} ${student.level >= 4 ? 'selected' : ''}">&#9733;</span>
                    <span class="star level_${scode} ${student.level >= 5 ? 'selected' : ''}">&#9733;</span>
                </div>
                <span class="score">${student.level}</span>
            `;
            focus.querySelector('.level_'+scode).onclick = (event) => handleRating(event, scode);

            const commentBox = document.createElement('div');
            commentBox.classList.add('comment-box');
            commentBox.innerHTML = `
                <label for="comment">Comment</label>
                <textarea id="comment_${scode}" maxlength="200">${student.evaluate}</textarea>
                <div class="char-counter">
                    <span id="charCount_${scode}">${student.evaluate.length}</span>/200
                </div>
            `;
            commentBox.querySelector('textarea').oninput = (event) => handleComment(event, scode);

            studentDetails.appendChild(listening);
            studentDetails.appendChild(readingWriting);
            studentDetails.appendChild(focus);
            studentDetails.appendChild(commentBox);

            studentItem.appendChild(studentInfo);
            studentItem.appendChild(studentDetails);

            studentList.appendChild(studentItem);

            // studentItem.innerHTML = `
            //     <h3>${student.name}</h3>
            //     <label for="status-${student.code}">Status:</label>
            //     <div class="status">
            //         <label><input type="radio" name="status-${student.code}" value="0" ${student.state === "0" ? "checked" : ""} onchange="handleStatusChange('${student.code}', this)"> Normal</label>
            //         <label><input type="radio" name="status-${student.code}" value="1" ${student.state === "1" ? "checked" : ""} onchange="handleStatusChange('${student.code}', this)"> Late</label>
            //         <label><input type="radio" name="status-${student.code}" value="9" ${student.state === "9" ? "checked" : ""} onchange="handleStatusChange('${student.code}', this)"> Absent</label>
            //     </div>
            //     <div class="status">
            //         <label for="feedback-${student.code}">Feedback:</label>
            //         <textarea id="feedback-${student.code}">${student.evaluate}</textarea>
            //     </div>
            //      <div class="status">
            //         <label for="feedback-${student.code}">HomeWork Upload:</label>
            //         <div class="upload-btn-wrapper">
            //             <button class="btn">Choose File</button>
            //             <input type="file" id="fileUpload" onchange="uploadFile()"  />
            //         </div>
            //         <span class="file-name" id="fileName">No file</span>
            //         <div class="status" id="status"></div>
            //     </div>
            // `;
            // studentList.appendChild(studentItem);
        });
    }

    function uploadFile() {
        const fileInput = document.getElementById('fileUpload');
        const fileName = document.getElementById('fileName');
        const status = document.getElementById('status');
        const file = fileInput.files[0];

        if (file) {


            // ÂàõÂª∫ FormData ÂØπË±°
            const formData = new FormData();
            formData.append('file', file);

            // ÂêëÊúçÂä°Âô®ÂèëÈÄÅÊñá‰ª∂
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json()) // ÂÅáËÆæÊúçÂä°Âô®ËøîÂõûÊñáÊú¨
                .then(result => {
                    fileName.innerHTML = result.data;
                    status.textContent = result.msg;
                })
                .catch(error => {
                    status.textContent = 'Failed to upload file.';
                    console.error('Error:', error);
                });
        } else {
            fileName.textContent = "No file chosen";
        }
    }

    async function fetchData() {
        try {
            const selectedDate = document.getElementById('selectedDate');
            dt = selectedDate.value;
            const response = await fetch(url + '/course/GetData', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ date: dt, subid })
            });
            const result = await response.json();

            if (result.code != 0) {
                alert('Network response was not ok ' + response.statusText);
            }
            const courseList = document.getElementById('courseList');
            courseList.innerHTML = '';
            today_course = result.data;

            if (result.data.length == 0) {
                const courseItem = document.createElement('div');
                courseItem.classList.add('course-item');
                courseItem.textContent = "You didn't schedule any classes today, have a great timeÔºÅÔºÅÔºÅ";
                courseList.appendChild(courseItem);
                return;
            }

            result.data.forEach((course, index) => {
                const courseItem = document.createElement('div');
                courseItem.classList.add('course-item');
                if (index % 3 == 0) {
                    courseItem.innerHTML += `<div class="course-icon">üéì</div>`;
                } else if (index % 3 == 1) {
                    courseItem.innerHTML += `<div class="course-icon">üé®</div>`;
                } else {
                    courseItem.innerHTML += `<div class="course-icon">üíª</div>`;
                }
                courseItem.innerHTML +=
                    `<div class="course-info">
                    <h4>${course.title}</h4>
                    <p><i class="fas fa-clock"></i>&nbsp;&nbsp;${course.date}&nbsp;&nbsp;${formatTime(course.start_dt)} ~ ${formatTime(course.end_dt)}</p>
                    <p><i class="fas fa-user"></i>&nbsp;&nbsp;${course.who ? replaceCommas(course.who) : ''}</p>
                </div>
                <div class="course-arrow"><i class="fas fa-angle-right"></i></div>`;
                courseItem.onclick = () => showDetails(course);
                courseList.appendChild(courseItem);
            });

        } catch (error) {
            console.error('There has been a problem with your fetch operation:', error);
        }
    }

    async function fetchNewMessages() {
        const response = await fetch(url + '/message?code=' + subid, {
            method: 'GET'
        });
        const result = await response.json();

        if (result.code != 0) {
            alert('Network response was not ok ' + response.statusText);
            return;
        }
        messages = [];
        result.data.forEach(item => {
            const newMessage = {
                text: item.msg,
                url: item.url,
                time: item.create_date
            };
            messages.push(newMessage);
        });

        // Â≠òÂÇ®Ê∂àÊÅØÂà∞ localStorage
        localStorage.setItem('messages', JSON.stringify(messages));

        updateNotificationCount(messages.length);
    }

    function changeDate(days) {
        const dateInput = document.getElementById('selectedDate');
        const currentDate = new Date(dateInput.value);
        currentDate.setDate(currentDate.getDate() + days);
        dateInput.value = currentDate.toISOString().split('T')[0];
        fetchData();
    }

    // ÊòæÁ§∫ÊàñÈöêËóèÊ∂àÊÅØÂºπÂá∫Ê°Ü
    function toggleNotificationPopup() {
        const popup = document.getElementById('notification-popup');
        if (popup.style.display === 'none' || popup.style.display === '') {
            loadNotifications();
            popup.style.display = 'block';
        } else {
            popup.style.display = 'none';
        }
    }

    // Á§∫‰æãÔºöÊõ¥Êñ∞Ê∂àÊÅØÊï∞
    function updateNotificationCount(count) {
        document.getElementById('notification-count').innerText = count;
    }
    // Âä†ËΩΩÊ∂àÊÅØËÆ∞ÂΩï
    function loadNotifications() {
        const messages = JSON.parse(localStorage.getItem('messages')) || [];
        const notificationList = document.getElementById('notification-list');
        notificationList.innerHTML = '';
        messages.forEach(message => {
            const listItem = document.createElement('li');
            listItem.innerHTML = `<a href="${message.url}">${message.text}</a> &nbsp;&nbsp;<small>${message.time}</small>`;
            notificationList.appendChild(listItem);
        });
    }

    function toggleDetails(scode) {
        const details = document.getElementById('details_'+scode);
        const arrow = document.getElementById('arrow_'+scode);

        if (details.classList.contains('hidden')) {
            details.classList.remove('hidden');
            arrow.classList.add('rotated');
        } else {
            details.classList.add('hidden');
            arrow.classList.remove('rotated');
        }
    }

    function handleRating(e,scode){
        console.log('handleRating');
        const category = starContainer.getAttribute('data-category');
            const selectedStar = e.target;
            const starIndex = Array.from(starContainer.children).indexOf(selectedStar) + 1;

            // Update the star selection visually
            updateStars(starContainer, starIndex);

            // Update the score
            document.getElementById(`${category}-score`).textContent = starIndex;
    }

    const stars = document.querySelectorAll('.stars');
    stars.forEach(starContainer => {
        starContainer.addEventListener('click', (e) => {
            const category = starContainer.getAttribute('data-category');
            const selectedStar = e.target;
            const starIndex = Array.from(starContainer.children).indexOf(selectedStar) + 1;

            // Update the star selection visually
            updateStars(starContainer, starIndex);

            // Update the score
            document.getElementById(`${category}-score`).textContent = starIndex;
        });
    });

    function updateStars(container, rating) {
        const stars = container.children;
        for (let i = 0; i < stars.length; i++) {
            stars[i].classList.remove('selected');
            if (i < rating) {
                stars[i].classList.add('selected');
            }
        }
    }

    // Character count for the comment box
    const commentBox = document.getElementById('comment');
    const charCount = document.getElementById('charCount');

    commentBox.addEventListener('input', () => {
        charCount.textContent = commentBox.value.length;
    });

    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    function formatDateTime(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}`;
    }
    function formatTime(date) {
        date = new Date(date);
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
    }

    function replaceCommas(str) {
        console.log(str);
        let resStr = str.split(/[,Ôºå]+/).join('Ôºå')
        resStr = resStr.substring(0, resStr.length - 1);
        return resStr;
    }

</script>